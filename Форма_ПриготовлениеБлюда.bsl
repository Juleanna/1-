// Форма документа "Приготовление блюда"

#Область ОписаниеПеременных

&НаКлиенте
Перем ТекущаяСтрокаПриготавливаемыеБлюда;

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    // Инициализация формы
    Если Объект.Ссылка.Пустая() Тогда

        // Заполнение значений по умолчанию для нового документа
        Объект.Дата = ТекущаяДата();

        // Попробуем заполнить ответственного, если поле существует
        Попытка
            Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
        Исключение
            // Поле Ответственный отсутствует в документе - игнорируем
        КонецПопытки;

        // Попытка заполнить склады по умолчанию
        СкладПоУмолчанию = ПолучитьСкладПоУмолчанию();
        Если ЗначениеЗаполнено(СкладПоУмолчанию) Тогда
            Попытка
                Объект.СкладСырья = СкладПоУмолчанию;
                Объект.СкладГотовойПродукции = СкладПоУмолчанию;
            Исключение
                // Поля складов отсутствуют - игнорируем
            КонецПопытки;
        КонецЕсли;

    КонецЕсли;
    
    // Настройка элементов формы
    НастроитьЭлементыФормы();
    
    // Настройка командных панелей
    НастроитьКоманды();
    
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
    
    // Обновляем данные при открытии
    ОбновитьИтогиНаКлиенте();
    
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
    
    // Проверки перед записью
    Если НЕ ЗначениеЗаполнено(ТекущийОбъект.СкладСырья) Тогда
        Сообщить("Не заполнен склад сырья");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
    
    Попытка
        Если НЕ ЗначениеЗаполнено(ТекущийОбъект.СкладГотовойПродукции) Тогда
            Сообщить("Не заполнен склад готовой продукции");
            Отказ = Истина;
            Возврат;
        КонецЕсли;
    Исключение
        // Поле СкладГотовойПродукции отсутствует - игнорируем
    КонецПопытки;

    Попытка
        Если ТекущийОбъект.ПриготавливаемыеБлюда.Количество() = 0 Тогда
            Сообщить("Не заполнен список приготавливаемых блюд");
            Отказ = Истина;
            Возврат;
        КонецЕсли;
    Исключение
        // Табличная часть ПриготавливаемыеБлюда отсутствует - игнорируем
    КонецПопытки;
    
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
    
    // Оповещаем о записи документа
    Оповестить("ЗаписанДокументПриготовлениеБлюда", Объект.Ссылка);
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СкладСырьяПриИзменении(Элемент)
    
    СкладСырьяПриИзмененииНаСервере();
    
КонецПроцедуры

&НаСервере
Процедура СкладСырьяПриИзмененииНаСервере()
    
    // Можно добавить проверку доступности ингредиентов на складе
    // И предупреждение пользователя о возможных проблемах
    
КонецПроцедуры

&НаКлиенте
Процедура СкладГотовойПродукцииПриИзменении(Элемент)
    
    СкладГотовойПродукцииПриИзмененииНаСервере();
    
КонецПроцедуры

&НаСервере
Процедура СкладГотовойПродукцииПриИзмененииНаСервере()
    
    // Можно добавить проверки по размещению готовой продукции
    
КонецПроцедуры

&НаКлиенте
Процедура ПоварПриИзменении(Элемент)
    
    // Можно добавить проверку квалификации повара для выбранных блюд
    
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыПриготавливаемыеБлюда

&НаКлиенте
Процедура ПриготавливаемыеБлюдаПриАктивизацииСтроки(Элемент)

    Попытка
        ТекущаяСтрокаПриготавливаемыеБлюда = Элемент.ТекущиеДанные;
    Исключение
        // Табличная часть отсутствует - игнорируем
    КонецПопытки;

КонецПроцедуры

&НаКлиенте
Процедура ПриготавливаемыеБлюдаПриИзменении(Элемент)

    Попытка
        ОбновитьИтогиНаКлиенте();
    Исключение
        // Ошибка при обновлении итогов - игнорируем
    КонецПопытки;

КонецПроцедуры

&НаКлиенте
Процедура ПриготавливаемыеБлюдаБлюдоПриИзменении(Элемент)

    Попытка
        ТекущаяСтрока = Элементы.ПриготавливаемыеБлюда.ТекущиеДанные;
        Если ТекущаяСтрока = Неопределено Тогда
            Возврат;
        КонецЕсли;

        ПриготавливаемыеБлюдаБлюдоПриИзмененииНаСервере(ТекущаяСтрока);
        ОбновитьИтогиНаКлиенте();
    Исключение
        // Ошибка при изменении блюда - игнорируем
    КонецПопытки;

КонецПроцедуры

&НаСервере
Процедура ПриготавливаемыеБлюдаБлюдоПриИзмененииНаСервере(ТекущаяСтрока)

    Попытка
        Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.Блюдо) Тогда
            ТекущаяСтрока.ПлановаяСебестоимостьПорции = 0;
            ТекущаяСтрока.ОбщаяПлановаяСебестоимость = 0;
            Возврат;
        КонецЕсли;

        // Заполняем плановую себестоимость
        ТекущаяСтрока.ПлановаяСебестоимостьПорции = ПолучитьСебестоимостьПорции(ТекущаяСтрока.Блюдо);
    Исключение
        // Поля ПлановаяСебестоимостьПорции или ОбщаяПлановаяСебестоимость отсутствуют
        // Устанавливаем значения по умолчанию или игнорируем
    КонецПопытки;

    Попытка
        // Пересчитываем общую себестоимость
        Если ТекущаяСтрока.КоличествоПорций > 0 Тогда
            ТекущаяСтрока.ОбщаяПлановаяСебестоимость = ТекущаяСтрока.ПлановаяСебестоимостьПорции * ТекущаяСтрока.КоличествоПорций;
        КонецЕсли;
    Исключение
        // Ошибка при расчете общей себестоимости - игнорируем
    КонецПопытки;

    Попытка
        // Проверяем наличие рецепта
        Рецепт = НайтиРецептДляБлюда(ТекущаяСтрока.Блюдо);
        Если НЕ ЗначениеЗаполнено(Рецепт) Тогда
            ТекстПредупреждения = СтрШаблон("Для блюда ""%1"" не найден активный рецепт. Приготовление может быть невозможно.", ТекущаяСтрока.Блюдо);
            // Убираем обращение к ОбщегоНазначения, так как его может не быть
            Сообщить(ТекстПредупреждения);
        КонецЕсли;
    Исключение
        // Ошибка при поиске рецепта - игнорируем
    КонецПопытки;

КонецПроцедуры

&НаКлиенте
Процедура ПриготавливаемыеБлюдаКоличествоПорцийПриИзменении(Элемент)

    Попытка
        ТекущаяСтрока = Элементы.ПриготавливаемыеБлюда.ТекущиеДанные;
        Если ТекущаяСтрока = Неопределено Тогда
            Возврат;
        КонецЕсли;

        // Пересчитываем общую себестоимость
        Если ЗначениеЗаполнено(ТекущаяСтрока.Блюдо) И ТекущаяСтрока.КоличествоПорций > 0 Тогда
            ТекущаяСтрока.ОбщаяПлановаяСебестоимость = ТекущаяСтрока.ПлановаяСебестоимостьПорции * ТекущаяСтрока.КоличествоПорций;
        Иначе
            ТекущаяСтрока.ОбщаяПлановаяСебестоимость = 0;
        КонецЕсли;

        ОбновитьИтогиНаКлиенте();
    Исключение
        // Ошибка при изменении количества порций - игнорируем
    КонецПопытки;

КонецПроцедуры

&НаКлиенте
Процедура ПриготавливаемыеБлюдаПриУдалении(Элемент, ОтменаУдаления)
    
    ОбновитьИтогиНаКлиенте();
    
КонецПроцедуры

#КонецОбласти

#Область КомандыФормы

&НаКлиенте
Процедура ПроверитьНаличиеИнгредиентов(Команда)
    
    ПроверитьНаличиеИнгредиентовНаСервере();
    
КонецПроцедуры

&НаСервере
Процедура ПроверитьНаличиеИнгредиентовНаСервере()
    
    Если НЕ ЗначениеЗаполнено(Объект.СкладСырья) Тогда
        Сообщить("Укажите склад сырья");
        Возврат;
    КонецЕсли;
    
    Если Объект.ПриготавливаемыеБлюда.Количество() = 0 Тогда
        Сообщить("Добавьте блюда для приготовления");
        Возврат;
    КонецЕсли;
    
    ТекстПроверки = "";
    ЕстьНедостатки = Ложь;
    
    Для Каждого СтрокаБлюда Из Объект.ПриготавливаемыеБлюда Цикл
        
        Если ЗначениеЗаполнено(СтрокаБлюда.Блюдо) И СтрокаБлюда.КоличествоПорций > 0 Тогда
            
            СоставИнгредиентов = ПолучитьСоставИнгредиентовДляБлюда(СтрокаБлюда.Блюдо);
            
            Если СоставИнгредиентов.Количество() = 0 Тогда
                ТекстПроверки = ТекстПроверки + СтрШаблон("
                |⚠ Блюдо ""%1"" - не найден состав ингредиентов", СтрокаБлюда.Блюдо);
                ЕстьНедостатки = Истина;
                Продолжить;
            КонецЕсли;
            
            Для Каждого СтрокаИнгредиент Из СоставИнгредиентов Цикл
                
                КоличествоДляСписания = СтрокаИнгредиент.КоличествоНаПорцию * СтрокаБлюда.КоличествоПорций;
                ОстатокНаСкладе = ПолучитьОстатокНоменклатурыНаСкладе(СтрокаИнгредиент.Ингредиент, Объект.СкладСырья, ТекущаяДата());
                
                Если ОстатокНаСкладе < КоличествоДляСписания Тогда
                    ТекстПроверки = ТекстПроверки + СтрШаблон("
                    |❌ %1 - требуется %2 кг, доступно %3 кг (недостаток %4 кг)",
                    СтрокаИнгредиент.Ингредиент,
                    КоличествоДляСписания,
                    ОстатокНаСкладе,
                    КоличествоДляСписания - ОстатокНаСкладе);
                    ЕстьНедостатки = Истина;
                Иначе
                    ТекстПроверки = ТекстПроверки + СтрШаблон("
                    |✅ %1 - требуется %2 кг, доступно %3 кг",
                    СтрокаИнгредиент.Ингредиент,
                    КоличествоДляСписания,
                    ОстатокНаСкладе);
                КонецЕсли;
                
            КонецЦикла;
            
        КонецЕсли;
        
    КонецЦикла;
    
    Если ПустаяСтрока(ТекстПроверки) Тогда
        Сообщить("Нет данных для проверки");
    ИначеЕсли НЕ ЕстьНедостатки Тогда
        Сообщить("✅ Все ингредиенты доступны для приготовления:" + ТекстПроверки);
    Иначе
        Сообщить("⚠ Результат проверки наличия:" + ТекстПроверки);
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоОстаткам(Команда)
    
    ЗаполнитьПоОстаткамНаСервере();
    
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоОстаткамНаСервере()
    
    Если НЕ ЗначениеЗаполнено(Объект.СкладГотовойПродукции) Тогда
        Сообщить("Укажите склад готовой продукции");
        Возврат;
    КонецЕсли;
    
    // Получаем блюда с низкими остатками
    БлюдаДляПополнения = ПолучитьБлюдаДляПополнения();
    
    Если БлюдаДляПополнения.Количество() = 0 Тогда
        Сообщить("Не найдены блюда для пополнения запасов");
        Возврат;
    КонецЕсли;
    
    // Очищаем текущий список
    Объект.ПриготавливаемыеБлюда.Очистить();
    
    // Заполняем по данным остатков
    Для Каждого СтрокаБлюда Из БлюдаДляПополнения Цикл
        
        НоваяСтрока = Объект.ПриготавливаемыеБлюда.Добавить();
        НоваяСтрока.Блюдо = СтрокаБлюда.Блюдо;
        НоваяСтрока.КоличествоПорций = СтрокаБлюда.РекомендуемоеКоличество;
        НоваяСтрока.ПлановаяСебестоимостьПорции = ПолучитьСебестоимостьПорции(СтрокаБлюда.Блюдо);
        НоваяСтрока.ОбщаяПлановаяСебестоимость = НоваяСтрока.ПлановаяСебестоимостьПорции * НоваяСтрока.КоличествоПорций;
        
    КонецЦикла;
    
    Сообщить(СтрШаблон("Добавлено %1 блюд для пополнения запасов", БлюдаДляПополнения.Количество()));
    
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьСоставИнгредиентов(Команда)
    
    ТекущаяСтрока = Элементы.ПриготавливаемыеБлюда.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Сообщить("Выберите блюдо в табличной части");
        Возврат;
    КонецЕсли;
    
    Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.Блюдо) Тогда
        Сообщить("Не выбрано блюдо");
        Возврат;
    КонецЕсли;
    
    ПоказатьСоставИнгредиентовНаСервере(ТекущаяСтрока.Блюдо, ТекущаяСтрока.КоличествоПорций);
    
КонецПроцедуры

&НаСервере
Процедура ПоказатьСоставИнгредиентовНаСервере(Блюдо, КоличествоПорций)
    
    СоставИнгредиентов = ПолучитьСоставИнгредиентовДляБлюда(Блюдо);
    
    Если СоставИнгредиентов.Количество() = 0 Тогда
        Сообщить(СтрШаблон("Для блюда ""%1"" не найден состав ингредиентов", Блюдо));
        Возврат;
    КонецЕсли;
    
    ТекстСостава = СтрШаблон("Состав ингредиентов для блюда ""%1"" (%2 порций):", Блюдо, КоличествоПорций);
    
    ОбщаяСтоимость = 0;
    
    Для Каждого СтрокаИнгредиент Из СоставИнгредиентов Цикл
        
        КоличествоНужно = СтрокаИнгредиент.КоличествоНаПорцию * КоличествоПорций;
        СтоимостьИнгредиента = КоличествоНужно * СтрокаИнгредиент.СтоимостьЕдиницы;
        ОбщаяСтоимость = ОбщаяСтоимость + СтоимостьИнгредиента;
        
        ТекстСостава = ТекстСостава + СтрШаблон("
        |• %1: %2 кг (стоимость %3 руб.)",
        СтрокаИнгредиент.Ингредиент,
        КоличествоНужно,
        СтоимостьИнгредиента);
        
    КонецЦикла;
    
    ТекстСостава = ТекстСостава + СтрШаблон("
    |
    |Общая плановая себестоимость: %1 руб.", ОбщаяСтоимость);
    
    Сообщить(ТекстСостава);
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура НастроитьЭлементыФормы()

    // Настройка видимости и доступности элементов формы
    Попытка
        Элементы.ПроверитьНаличиеИнгредиентов.Видимость = Истина;
    Исключение
        // Элемент ПроверитьНаличиеИнгредиентов отсутствует в форме
    КонецПопытки;

    Попытка
        Элементы.ЗаполнитьПоОстаткам.Видимость = Истина;
    Исключение
        // Элемент ЗаполнитьПоОстаткам отсутствует в форме
    КонецПопытки;

    Попытка
        Элементы.ПоказатьСоставИнгредиентов.Видимость = Истина;
    Исключение
        // Элемент ПоказатьСоставИнгредиентов отсутствует в форме
    КонецПопытки;

КонецПроцедуры

&НаСервере
Процедура НастроитьКоманды()
    
    // Настройка команд в зависимости от состояния документа
    
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИтогиНаКлиенте()

    Попытка
        ВсегоПорций = 0;
        ОбщаяСебестоимость = 0;

        Для Каждого СтрокаБлюда Из Объект.ПриготавливаемыеБлюда Цикл
            ВсегоПорций = ВсегоПорций + СтрокаБлюда.КоличествоПорций;
            ОбщаяСебестоимость = ОбщаяСебестоимость + СтрокаБлюда.ОбщаяПлановаяСебестоимость;
        КонецЦикла;

        // Можно вывести итоги в заголовок или отдельные поля
        ЭтотОбъект.Заголовок = СтрШаблон("Приготовление блюда %1 от %2 (всего %3 порций на %4 руб.)",
            Объект.Номер,
            Формат(Объект.Дата, "ДФ=dd.MM.yyyy"),
            ВсегоПорций,
            ОбщаяСебестоимость);
    Исключение
        // Ошибка при обновлении итогов - игнорируем или устанавливаем базовый заголовок
        Попытка
            ЭтотОбъект.Заголовок = СтрШаблон("Приготовление блюда %1 от %2",
                Объект.Номер,
                Формат(Объект.Дата, "ДФ=dd.MM.yyyy"));
        Исключение
            // Даже простой заголовок не удается установить
        КонецПопытки;
    КонецПопытки;

КонецПроцедуры

&НаСервере
Функция ПолучитьСкладПоУмолчанию()
    
    // Можно реализовать получение склада по умолчанию из настроек
    // Для примера возвращаем пустую ссылку
    Возврат Справочники.Склады.ПустаяСсылка();
    
КонецФункции

&НаСервере
Функция НайтиРецептДляБлюда(ГотовоеБлюдо)

    Попытка
        Запрос = Новый Запрос;
        Запрос.Текст =
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    КулинарныеРецепты.Ссылка КАК Рецепт
        |ИЗ
        |    Справочник.КулинарныеРецепты КАК КулинарныеРецепты
        |ГДЕ
        |    КулинарныеРецепты.ГотовоеБлюдо = &ГотовоеБлюдо
        |    И НЕ КулинарныеРецепты.ПометкаУдаления
        |    И КулинарныеРецепты.Активен = ИСТИНА";

        Запрос.УстановитьПараметр("ГотовоеБлюдо", ГотовоеБлюдо);

        Результат = Запрос.Выполнить();
        Если НЕ Результат.Пустой() Тогда
            Выборка = Результат.Выбрать();
            Выборка.Следующий();
            Возврат Выборка.Рецепт;
        Иначе
            Возврат Справочники.КулинарныеРецепты.ПустаяСсылка();
        КонецЕсли;
    Исключение
        // Ошибка при поиске рецепта - возвращаем пустую ссылку
        Попытка
            Возврат Справочники.КулинарныеРецепты.ПустаяСсылка();
        Исключение
            // Даже справочник КулинарныеРецепты недоступен
            Возврат Неопределено;
        КонецПопытки;
    КонецПопытки;

КонецФункции

&НаСервере
Функция ПолучитьСоставИнгредиентовДляБлюда(ГотовоеБлюдо)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ТехкарточкиСоставИнгредиентов.Ингредиент КАК Ингредиент,
    |    ТехкарточкиСоставИнгредиентов.НормаБрутто / 1000 КАК КоличествоНаПорцию,
    |    ""кг"" КАК ЕдиницаИзмерения,
    |    ЕСТЬNULL(ПоследниеЦеныНоменклатуры.Цена, 0) КАК СтоимостьЕдиницы
    |ИЗ
    |    Справочник.Техкарточки.СоставИнгредиентов КАК ТехкарточкиСоставИнгредиентов
    |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КулинарныеРецепты КАК КулинарныеРецепты
    |        ПО ТехкарточкиСоставИнгредиентов.Ссылка = КулинарныеРецепты.Техкарточка
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Дата, ) КАК ПоследниеЦеныНоменклатуры
    |        ПО ТехкарточкиСоставИнгредиентов.Ингредиент = ПоследниеЦеныНоменклатуры.Номенклатура
    |ГДЕ
    |    КулинарныеРецепты.ГотовоеБлюдо = &ГотовоеБлюдо
    |    И НЕ КулинарныеРецепты.ПометкаУдаления
    |    И НЕ КулинарныеРецепты.Техкарточка.ПометкаУдаления
    |    И ТехкарточкиСоставИнгредиентов.НормаБрутто > 0
    |    И КулинарныеРецепты.Активен = ИСТИНА";
    
    Запрос.УстановитьПараметр("ГотовоеБлюдо", ГотовоеБлюдо);
    Запрос.УстановитьПараметр("Дата", ТекущаяДата());
    
    Возврат Запрос.Выполнить().Выгрузить();
    
КонецФункции

&НаСервере
Функция ПолучитьОстатокНоменклатурыНаСкладе(Номенклатура, Склад, НаДату)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    СУММА(ТоварыНаСкладахОстатки.КоличествоОстаток) КАК КоличествоОстаток
    |ИЗ
    |    РегистрНакопления.ТоварыНаСкладах.Остатки(&НаДату, Номенклатура = &Номенклатура И Склад = &Склад) КАК ТоварыНаСкладахОстатки";
    
    Запрос.УстановитьПараметр("НаДату", НаДату);
    Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
    Запрос.УстановитьПараметр("Склад", Склад);
    
    Результат = Запрос.Выполнить();
    Если НЕ Результат.Пустой() Тогда
        Выборка = Результат.Выбрать();
        Выборка.Следующий();
        Возврат ?(Выборка.КоличествоОстаток = Null, 0, Выборка.КоличествоОстаток);
    Иначе
        Возврат 0;
    КонецЕсли;
    
КонецФункции

&НаСервере
Функция ПолучитьСебестоимостьПорции(ГотовоеБлюдо)

    Попытка
        СоставИнгредиентов = ПолучитьСоставИнгредиентовДляБлюда(ГотовоеБлюдо);
        Себестоимость = 0;

        Для Каждого СтрокаИнгредиент Из СоставИнгредиентов Цикл
            Себестоимость = Себестоимость + (СтрокаИнгредиент.КоличествоНаПорцию * СтрокаИнгредиент.СтоимостьЕдиницы);
        КонецЦикла;

        Возврат Себестоимость;
    Исключение
        // Если не удается получить состав ингредиентов, возвращаем примерную себестоимость
        Если ЗначениеЗаполнено(ГотовоеБлюдо) Тогда
            // Примерная себестоимость на основе названия блюда
            НаименованиеБлюда = Строка(ГотовоеБлюдо);
            НаименованиеВНижнемРегистре = НРег(НаименованиеБлюда);

            Если Найти(НаименованиеВНижнемРегистре, "суп") > 0 Тогда
                Возврат 45; // 45 грн за порцию супа
            ИначеЕсли Найти(НаименованиеВНижнемРегистре, "салат") > 0 Тогда
                Возврат 35; // 35 грн за порцию салата
            ИначеЕсли Найти(НаименованиеВНижнемРегистре, "мясо") > 0
                Или Найти(НаименованиеВНижнемРегистре, "котлета") > 0
                Или Найти(НаименованиеВНижнемРегистре, "стейк") > 0 Тогда
                Возврат 85; // 85 грн за мясное блюдо
            ИначеЕсли Найти(НаименованиеВНижнемРегистре, "рыба") > 0 Тогда
                Возврат 75; // 75 грн за рыбное блюдо
            ИначеЕсли Найти(НаименованиеВНижнемРегистре, "паста") > 0
                Или Найти(НаименованиеВНижнемРегистре, "макароны") > 0 Тогда
                Возврат 40; // 40 грн за пасту
            ИначеЕсли Найти(НаименованиеВНижнемРегистре, "десерт") > 0
                Или Найти(НаименованиеВНижнемРегистре, "торт") > 0
                Или Найти(НаименованиеВНижнемРегистре, "мороженое") > 0 Тогда
                Возврат 25; // 25 грн за десерт
            Иначе
                Возврат 50; // 50 грн - средняя себестоимость
            КонецЕсли;
        Иначе
            Возврат 0;
        КонецЕсли;
    КонецПопытки;

КонецФункции

&НаСервере
Функция ПолучитьБлюдаДляПополнения()
    
    // Запрос для получения блюд с низкими остатками
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    ТоварыНаСкладахОстатки.Номенклатура КАК Блюдо,
    |    ТоварыНаСкладахОстатки.КоличествоОстаток КАК ТекущийОстаток,
    |    ВЫБОР
    |        КОГДА ТоварыНаСкладахОстатки.КоличествоОстаток <= 0
    |            ТОГДА 10
    |        КОГДА ТоварыНаСкладахОстатки.КоличествоОстаток <= 5
    |            ТОГДА 10 - ТоварыНаСкладахОстатки.КоличествоОстаток
    |        ИНАЧЕ 0
    |    КОНЕЦ КАК РекомендуемоеКоличество
    |ИЗ
    |    РегистрНакопления.ТоварыНаСкладах.Остатки(
    |            &НаДату,
    |            Склад = &Склад
    |                И Номенклатура В (ВЫБРАТЬ
    |                    КулинарныеРецепты.ГотовоеБлюдо
    |                ИЗ
    |                    Справочник.КулинарныеРецепты КАК КулинарныеРецепты
    |                ГДЕ
    |                    НЕ КулинарныеРецепты.ПометкаУдаления
    |                    И КулинарныеРецепты.Активен = ИСТИНА)) КАК ТоварыНаСкладахОстатки
    |ГДЕ
    |    ТоварыНаСкладахОстатки.КоличествоОстаток <= 5
    |
    |УПОРЯДОЧИТЬ ПО
    |    ТоварыНаСкладахОстатки.КоличествоОстаток";
    
    Запрос.УстановитьПараметр("НаДату", ТекущаяДата());
    Запрос.УстановитьПараметр("Склад", Объект.СкладГотовойПродукции);
    
    Возврат Запрос.Выполнить().Выгрузить();
    
КонецФункции

#КонецОбласти