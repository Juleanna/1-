// Патч: отказ от константы Константы.ПользовательСтандартногоИнтерфейсаOData
// Использование справочника "Константа" (элемент с наименованием
// "ПользовательСтандартногоИнтерфейсаOData") для хранения ссылки на пользователя.

#Область СлужебныеПроцедурыИФункции

// Возвращает роль для стандартного интерфейса OData
Функция РольДляСтандартногоИнтерфейсаOData() Экспорт
    Возврат Метаданные.Роли.УдаленныйДоступOData;
КонецФункции

// Проверяет возможность создания пользователя для вызовов стандартного интерфейса OData
Процедура ПроверитьВозможностьСозданияПользователяДляВызововСтандартногоИнтерфейсаOData() Экспорт
    УстановитьПривилегированныйРежим(Истина);
    КоличествоПользователей = ПользователиИнформационнойБазы.ПолучитьПользователей().Количество();
    УстановитьПривилегированныйРежим(Ложь);

    Если КоличествоПользователей = 0 Тогда
        ВызватьИсключение НСтр("ru='Нельзя создать отдельные логин и пароль для использования автоматического REST-сервиса, т.к. в программе отсутствуют другие пользователи.';uk='Не можна створити окремі логін і пароль для використання автоматичного REST-сервісу, тому що в програмі відсутні інші користувачі.'");
    КонецЕсли;
КонецПроцедуры

// Возвращает ссылку на пользователя, сохраненную в элементе справочника
// "Константа" с наименованием "ПользовательСтандартногоИнтерфейсаOData".
// Если справочник или элемент отсутствуют — возвращает пустую ссылку Пользователи.
Функция ПолучитьПользователяODataИзСправочника() Экспорт

    // Проверим наличие справочника "Константа" в метаданных
    Попытка
        МетаСпрКонстанта = Метаданные.Справочники.Константа;
    Исключение
        Возврат Справочники.Пользователи.ПустаяСсылка();
    КонецПопытки;

    Элемент = Справочники.Константа.НайтиПоНаименованию("ПользовательСтандартногоИнтерфейсаOData");
    Если Не ЗначениеЗаполнено(Элемент) Тогда
        Возврат Справочники.Пользователи.ПустаяСсылка();
    КонецЕсли;

    Попытка
        Объект = Элемент.ПолучитьОбъект();

        // Предпочтительно атрибут с именем "Пользователь" (тип: СправочникСсылка.Пользователи)
        Если Объект.Свойство("Пользователь") Тогда
            Возврат Объект.Пользователь;
        КонецЕсли;

        // Резервный вариант — хранение в ДополнительныхСвойствах
        Если Объект.ДополнительныеСвойства.Свойство("Пользователь") Тогда
            Возврат Объект.ДополнительныеСвойства.Пользователь;
        КонецЕсли;
    Исключение
        // Игнорируем и вернем пустую ссылку
    КонецПопытки;

    Возврат Справочники.Пользователи.ПустаяСсылка();

КонецФункции

// Сохраняет ссылку пользователя в элементе справочника "Константа" c
// наименованием "ПользовательСтандартногоИнтерфейсаOData". Если элемент
// отсутствует — создает его. Если отсутствует подходящий атрибут, сохраняет
// в ДополнительныеСвойства с ключом "Пользователь".
Процедура СохранитьПользователяODataВСправочник(СсылкаПользователя) Экспорт

    // Проверим наличие справочника "Константа" в метаданных
    Попытка
        МетаСпрКонстанта = Метаданные.Справочники.Константа;
    Исключение
        // Нет справочника — ничего не делаем
        Возврат;
    КонецПопытки;

    Элемент = Справочники.Константа.НайтиПоНаименованию("ПользовательСтандартногоИнтерфейсаOData");
    Если ЗначениеЗаполнено(Элемент) Тогда
        Объект = Элемент.ПолучитьОбъект();
    Иначе
        Объект = Справочники.Константа.СоздатьЭлемент();
        Объект.Наименование = "ПользовательСтандартногоИнтерфейсаOData";
    КонецЕсли;

    Если Объект.Свойство("Пользователь") Тогда
        Объект.Пользователь = СсылкаПользователя;
    Иначе
        Объект.ДополнительныеСвойства.Вставить("Пользователь", СсылкаПользователя);
    КонецЕсли;

    Объект.Записать();

КонецПроцедуры

// Измененный фрагмент: вместо чтения из константы получаем пользователя из справочника
Функция СвойстваПользователяСтандартногоИнтерфейсаOData() Экспорт

    Если Не ПравоДоступа("АдминистрированиеДанных", Метаданные) Тогда
        ВызватьИсключение НСтр("ru='Недостаточно прав доступа для настройки автоматического REST-сервиса';uk='Недостатньо прав доступу для налаштування автоматичного REST-Сервісу'");
    КонецЕсли;

    УстановитьПривилегированныйРежим(Истина);

    Результат = Новый Структура;
    Результат.Вставить("Пользователь", Справочники.Пользователи.ПустаяСсылка());
    Результат.Вставить("Идентификатор");
    Результат.Вставить("Имя", "");
    Результат.Вставить("Аутентификация", Ложь);

    // Было: Пользователь = Константы.ПользовательСтандартногоИнтерфейсаOData.Получить();
    Пользователь = ПолучитьПользователяODataИзСправочника();

    Если ЗначениеЗаполнено(Пользователь) Тогда

        Результат.Пользователь = Пользователь;

        Идентификатор = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Пользователь, "ИдентификаторПользователяИБ");

        Если ЗначениеЗаполнено(Идентификатор) Тогда

            Результат.Идентификатор = Идентификатор;

            ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(Идентификатор);

            Если ПользовательИБ <> Неопределено Тогда

                Результат.Имя = ПользовательИБ.Имя;
                Результат.Аутентификация = ПользовательИБ.АутентификацияСтандартная;

            КонецЕсли;

        КонецЕсли;

    КонецЕсли;

    Возврат Результат;

КонецФункции

// Измененный фрагмент: вместо установки константы — запись в справочник
Процедура ЗаписатьНастройкиАвторизацииДляСтандартногоИнтерфейсаOData(Знач НастройкиАвторизации) Экспорт

    СвойстваПользователя = СвойстваПользователяСтандартногоИнтерфейсаOData();

    Если НастройкиАвторизации.Используется Тогда

        ПроверитьВозможностьСозданияПользователяДляВызововСтандартногоИнтерфейсаOData();

        ОписаниеПользователяИБ = Новый Структура();
        ОписаниеПользователяИБ.Вставить("Действие", "Записать");
        ОписаниеПользователяИБ.Вставить("Имя", НастройкиАвторизации.Логин);
        ОписаниеПользователяИБ.Вставить("АутентификацияСтандартная", Истина);
        ОписаниеПользователяИБ.Вставить("АутентификацияОС", Ложь);
        ОписаниеПользователяИБ.Вставить("АутентификацияOpenID", Ложь);
        ОписаниеПользователяИБ.Вставить("ПоказыватьВСпискеВыбора", Ложь);
        Если НастройкиАвторизации.Свойство("Пароль") Тогда
            ОписаниеПользователяИБ.Вставить("Пароль", НастройкиАвторизации.Пароль);
        КонецЕсли;
        ОписаниеПользователяИБ.Вставить("ЗапрещеноИзменятьПароль", Истина);
        ОписаниеПользователяИБ.Вставить("Роли",
            ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(
            РольДляСтандартногоИнтерфейсаOData().Имя));

        НачатьТранзакцию();
        Попытка

            Если ЗначениеЗаполнено(СвойстваПользователя.Пользователь) Тогда

                Блокировка = Новый БлокировкаДанных;
                ЭлементБлокировки = Блокировка.Добавить("Справочник.Пользователи");
                ЭлементБлокировки.УстановитьЗначение("Ссылка", СвойстваПользователя.Пользователь);
                Блокировка.Заблокировать();

                ПользовательСтандартногоИнтерфейсаOData = СвойстваПользователя.Пользователь.ПолучитьОбъект();

            Иначе
                ПользовательСтандартногоИнтерфейсаOData = Справочники.Пользователи.СоздатьЭлемент();
            КонецЕсли;

            ПользовательСтандартногоИнтерфейсаOData.Наименование = НСтр("ru='Автоматический REST-сервис';uk='Автоматичний REST-сервіс'");
            ПользовательСтандартногоИнтерфейсаOData.Служебный = Истина;
            ПользовательСтандартногоИнтерфейсаOData.ДополнительныеСвойства.Вставить("ОписаниеПользователяИБ", ОписаниеПользователяИБ);
            ПользовательСтандартногоИнтерфейсаOData.Записать();

            // Было: Константы.ПользовательСтандартногоИнтерфейсаOData.Установить(ПользовательСтандартногоИнтерфейсаOData.Ссылка);
            СохранитьПользователяODataВСправочник(ПользовательСтандартногоИнтерфейсаOData.Ссылка);

            Если ОписаниеПользователяИБ.Свойство("Пароль") Тогда
                ОписаниеПользователяИБ.Удалить("Пароль");
            КонецЕсли;

            СокращенноеОписание = Новый Структура;
            ОбщегоНазначенияКлиентСервер.ДополнитьСтруктуру(СокращенноеОписание, ОписаниеПользователяИБ);
            СокращенноеОписание.Удалить("ПользовательИБ");

            Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
                НСтр("ru='Выполнена запись пользователя для стандартного интерфейса OData.'" +
                    "\n\nОписание пользователя ИБ:" +
                    "\n-------------------------------------------" +
                    "\n%1" +
                    "\n-------------------------------------------" +
                    "\n\nРезультат:" +
                    "\n-------------------------------------------" +
                    "\n%2" +
                    "\n-------------------------------------------';uk='Виконаний запис користувача для стандартного інтерфейсу OData.'" +
                    "\n\nОпис користувача ІБ:" +
                    "\n-------------------------------------------" +
                    "\n%1" +
                    "\n-------------------------------------------" +
                    "\n\nРезультат:" +
                    "\n-------------------------------------------" +
                    "\n%2" +
                    "\n-------------------------------------------'"),
                ОбщегоНазначения.ЗначениеВСтрокуXML(СокращенноеОписание),
                ПользовательСтандартногоИнтерфейсаOData.ДополнительныеСвойства.ОписаниеПользователяИБ.РезультатДействия);

            ЗаписьЖурналаРегистрации(
                НСтр("ru='Настройка стандартного интерфейса OData.Запись пользователя';uk='Налаштування стандартного інтерфейсу OData.Запис користувача'", ОбщегоНазначения.КодОсновногоЯзыка()),
                УровеньЖурналаРегистрации.Информация,
                Метаданные.Справочники.Пользователи,
                ,
                Комментарий);

            ЗафиксироватьТранзакцию();

        Исключение

            ОтменитьТранзакцию();
            ОписаниеПользователяИБ.Удалить("Пароль");

            Комментарий = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
                НСтр("ru='При записи пользователя для стандартного интерфейса OData произошла ошибка.'" +
                    "\n\nОписание пользователя ИБ:" +
                    "\n-------------------------------------------" +
                    "\n%1" +
                    "\n-------------------------------------------" +
                    "\n\nТекст ошибки:" +
                    "\n-------------------------------------------" +
                    "\n%2" +
                    "\n-------------------------------------------';uk='При записі користувача для стандартного інтерфейсу OData відбулася помилка.'" +
                    "\n\nОпис користувача ІБ:" +
                    "\n-------------------------------------------" +
                    "\n%1" +
                    "\n-------------------------------------------" +
                    "\n\nТекст помилки:" +
                    "\n-------------------------------------------" +
                    "\n%2" +
                    "\n-------------------------------------------'"),
                ОбщегоНазначения.ЗначениеВСтрокуXML(ОписаниеПользователяИБ),
                ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));

            ЗаписьЖурналаРегистрации(
                НСтр("ru='Настройка стандартного интерфейса OData.Запись пользователя';uk='Налаштування стандартного інтерфейсу OData.Запис користувача'", ОбщегоНазначения.КодОсновногоЯзыка()),
                УровеньЖурналаРегистрации.Ошибка,
                Метаданные.Справочники.Пользователи,
                ,
                Комментарий);

            ВызватьИсключение;

        КонецПопытки;

    Иначе

        Если ЗначениеЗаполнено(СвойстваПользователя.Пользователь) Тогда

            // Требуется заблокировать пользователя ИБ
            ОписаниеПользователяИБ = Новый Структура();
            ОписаниеПользователяИБ.Вставить("Действие", "Записать");
            ОписаниеПользователяИБ.Вставить("ВходВПрограммуРазрешен", Ложь);

            ПользовательСтандартногоИнтерфейсаOData = СвойстваПользователя.Пользователь.ПолучитьОбъект();
            ПользовательСтандартногоИнтерфейсаOData.ДополнительныеСвойства.Вставить("ОписаниеПользователяИБ", ОписаниеПользователяИБ);
            ПользовательСтандартногоИнтерфейсаOData.Служебный = Истина;
            ПользовательСтандартногоИнтерфейсаOData.Записать();

            // При выключении авторизации пользователе не удаляем ссылку из справочника,
            // оставляем как историю выбора. При необходимости — очистите элемент вручную.

        КонецЕсли;

    КонецЕсли;

КонецПроцедуры

#КонецОбласти
