# ПОЛНАЯ ИНСТРУКЦИЯ ПО ВНЕДРЕНИЮ СИСТЕМЫ ЦЕН НА ИНГРЕДИЕНТЫ

## СОДЕРЖАНИЕ
1. [Подготовка к работе](#подготовка-к-работе)
2. [Создание справочника "Цены на ингредиенты"](#создание-справочника-цены-на-ингредиенты)
3. [Модификация справочника "Техкарточки"](#модификация-справочника-техкарточки)
4. [Создание общего модуля расчетов](#создание-общего-модуля-расчетов)
5. [Создание модулей менеджеров](#создание-модулей-менеджеров)
6. [Модификация форм](#модификация-форм)
7. [Создание дополнительных элементов](#создание-дополнительных-элементов)
8. [Обновление базы данных](#обновление-базы-данных)
9. [Первоначальное заполнение](#первоначальное-заполнение)
10. [Тестирование системы](#тестирование-системы)

---

## ПОДГОТОВКА К РАБОТЕ

### Требования:
- 1С:Предприятие 8.3 или выше
- Режим "Конфигуратор"
- Права администратора на изменение конфигурации
- Существующие справочники: Номенклатура, КлассификаторЕдиницИзмерения, Контрагенты

### Резервное копирование:
**⚠️ ОБЯЗАТЕЛЬНО:** Создайте резервную копию базы данных перед началом работ!

1. Откройте 1С:Предприятие в режиме "Конфигуратор"
2. Меню "Администрирование" → "Выгрузить информационную базу"
3. Сохраните файл с именем `backup_before_price_system_YYYYMMDD.dt`

---

## СОЗДАНИЕ СПРАВОЧНИКА "ЦЕНЫ НА ИНГРЕДИЕНТЫ"

### Шаг 1.1: Создание справочника

1. **Откройте конфигуратор 1С**
2. В дереве метаданных найдите узел **"Справочники"**
3. Щелкните правой кнопкой мыши → **"Добавить"**
4. В появившемся диалоге укажите:
   ```
   Имя: ЦеныНаИнгредиенты
   Синоним: Цены на ингредиенты
   Комментарий: Справочник для централизованного ведения цен на ингредиенты и сырье
   ```
5. Нажмите **"ОК"**

### Шаг 1.2: Настройка основных свойств

1. Откройте созданный справочник двойным щелчком
2. На закладке **"Основные"** установите:
   ```
   Длина кода: 9
   Тип кода: Строка
   Серия кодов: Общая для всего справочника
   Автонумерация: Да
   Проверка уникальности: Да
   Представление по умолчанию: В виде наименования
   Ввод по строке: Наименование
   Быстрый выбор: Да
   ```

### Шаг 1.3: Создание реквизитов

#### Реквизит "Ингредиент"
1. Правой кнопкой на узле **"Реквизиты"** → **"Добавить"**
2. Заполните поля:
   ```
   Имя: Ингредиент
   Синоним: Ингредиент
   Комментарий: Ссылка на номенклатуру ингредиента
   ```
3. На закладке **"Тип"**:
   - Нажмите **"..."**
   - Выберите **"Справочники"** → **"Номенклатура"**
   - Нажмите **"ОК"**
4. На закладке **"Данные"**:
   ```
   Обязательное заполнение: Да
   Проверка заполнения: Выдавать ошибку
   Папки и элементы: Элементы
   ```
5. На закладке **"Представление"**:
   ```
   Подсказка: Выберите ингредиент из справочника номенклатуры
   ```

#### Реквизит "ЕдиницаИзмерения"
1. Добавьте новый реквизит:
   ```
   Имя: ЕдиницаИзмерения
   Синоним: Единица измерения
   Комментарий: Единица измерения для цены (кг, л, шт.)
   ```
2. Тип: **СправочникСсылка.КлассификаторЕдиницИзмерения**
3. Обязательное заполнение: **Да**

#### Реквизит "ЦенаЗаЕдиницу"
1. Добавьте реквизит:
   ```
   Имя: ЦенаЗаЕдиницу
   Синоним: Цена за единицу
   Комментарий: Цена за единицу измерения ингредиента
   ```
2. На закладке **"Тип"**:
   - Выберите **"Число"**
   - Длина: **15**
   - Точность: **2**
   - Неотрицательное: **Да**
3. Обязательное заполнение: **Да**

#### Реквизит "ДатаУстановкиЦены"
1. Добавьте реквизит:
   ```
   Имя: ДатаУстановкиЦены
   Синоним: Дата установки цены
   Комментарий: Дата установки или последнего изменения цены
   ```
2. Тип: **Дата**
3. Части даты: **Дата**

#### Реквизит "Поставщик"
1. Добавьте реквизит:
   ```
   Имя: Поставщик
   Синоним: Поставщик
   Комментарий: Основной поставщик ингредиента
   ```
2. Тип: **СправочникСсылка.Контрагенты**

#### Реквизит "Активность"
1. Добавьте реквизит:
   ```
   Имя: Активность
   Синоним: Активность
   Комментарий: Признак активности цены
   ```
2. Тип: **Булево**
3. Значение заполнения: **Истина**

#### Реквизит "Комментарий"
1. Добавьте реквизит:
   ```
   Имя: Комментарий
   Синоним: Комментарий
   Комментарий: Дополнительная информация о цене
   ```
2. Тип: **Строка**, длина **500**
3. На закладке **"Представление"**: Многострочность: **Да**

### Шаг 1.4: Создание табличной части "ИсторияЦен"

1. Правой кнопкой на узле **"Табличные части"** → **"Добавить"**
2. Заполните:
   ```
   Имя: ИсторияЦен
   Синоним: История изменения цен
   Комментарий: Архив изменений цен для анализа динамики
   ```

#### Реквизиты табличной части:

**Колонка "ДатаИзменения":**
1. Правой кнопкой на **"Реквизиты"** → **"Добавить"**
2. ```
   Имя: ДатаИзменения
   Синоним: Дата изменения
   Тип: Дата (части даты: Дата)
   ```

**Колонка "СтараяЦена":**
1. ```
   Имя: СтараяЦена
   Синоним: Старая цена
   Тип: Число (15,2), неотрицательное
   ```

**Колонка "НоваяЦена":**
1. ```
   Имя: НоваяЦена
   Синоним: Новая цена
   Тип: Число (15,2), неотрицательное
   ```

**Колонка "ПричинаИзменения":**
1. ```
   Имя: ПричинаИзменения
   Синоним: Причина изменения
   Тип: Строка (200)
   ```

---

## МОДИФИКАЦИЯ СПРАВОЧНИКА "ТЕХКАРТОЧКИ"

### Шаг 2.1: Добавление нового реквизита в табличную часть

1. Откройте справочник **"Техкарточки"**
2. Раскройте узел **"Табличные части"** → **"СоставИнгредиентов"**
3. Правой кнопкой на **"Реквизиты"** → **"Добавить"**
4. **ВАЖНО:** Новый реквизит должен быть расположен ПЕРЕД существующим "СтоимостьЕдиницы"

#### Реквизит "ЦенаИнгредиента"
1. Заполните:
   ```
   Имя: ЦенаИнгредиента
   Синоним: Цена ингредиента
   Комментарий: Ссылка на цену ингредиента из справочника цен
   ```
2. Тип: **СправочникСсылка.ЦеныНаИнгредиенты**
3. На закладке **"Данные"** → **"Связи параметров выбора"**:
   - Нажмите **"Добавить"**
   - Имя связи: **Ингредиент**
   - Путь к данным: **Ингредиент**

### Шаг 2.2: Изменение существующего реквизита "СтоимостьЕдиницы"

1. Откройте реквизит **"СтоимостьЕдиницы"**
2. Измените:
   ```
   Синоним: Цена за кг (авто)
   Комментарий: Автоматически заполняемая цена ингредиента за кг
   ```
3. На закладке **"Представление"**:
   ```
   Только просмотр: Да
   Подсказка: Цена автоматически заполняется из справочника цен
   ```

---

## СОЗДАНИЕ ОБЩЕГО МОДУЛЯ РАСЧЕТОВ

### Шаг 3.1: Создание модуля

1. В дереве метаданных найдите **"Общие модули"**
2. Правой кнопкой → **"Добавить"**
3. Заполните:
   ```
   Имя: РасчетСебестоимости
   Синоним: Расчет себестоимости
   Комментарий: Модуль для автоматического расчета себестоимости блюд
   ```
4. Установите флажки:
   - ✅ **Сервер**
   - ✅ **Вызов сервера**
   - ✅ **Клиент (управляемое приложение)**

### Шаг 3.2: Код модуля

Откройте модуль и вставьте следующий код:

```bsl
////////////////////////////////////////////////////////////////////////////////
// МОДУЛЬ ДЛЯ РАСЧЕТА СЕБЕСТОИМОСТИ БЛЮД
// Автоматический расчет на основе цен ингредиентов из справочника
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Рассчитать себестоимость техкарточки
//
// Параметры:
//  ТехКарточкаСсылка - СправочникСсылка.Техкарточки - Ссылка на технологическую карту
//
// Возвращаемое значение:
//  Число - Себестоимость одной порции
//
Функция РассчитатьСебестоимостьТехКарточки(ТехКарточкаСсылка) Экспорт

	Если НЕ ЗначениеЗаполнено(ТехКарточкаСсылка) Тогда
		Возврат 0;
	КонецЕсли;

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТехкарточкиСоставИнгредиентов.Ингредиент КАК Ингредиент,
	|	ТехкарточкиСоставИнгредиентов.НормаБрутто КАК НормаБрутто,
	|	ТехкарточкиСоставИнгредиентов.НормаНетто КАК НормаНетто,
	|	ТехкарточкиСоставИнгредиентов.ЦенаИнгредиента КАК ЦенаИнгредиента,
	|	ТехкарточкиСоставИнгредиентов.СтоимостьЕдиницы КАК СтоимостьЕдиницы
	|ИЗ
	|	Справочник.Техкарточки.СоставИнгредиентов КАК ТехкарточкиСоставИнгредиентов
	|ГДЕ
	|	ТехкарточкиСоставИнгредиентов.Ссылка = &ТехКарточка";

	Запрос.УстановитьПараметр("ТехКарточка", ТехКарточкаСсылка);

	РезультатЗапроса = Запрос.Выполнить();

	Если РезультатЗапроса.Пустой() Тогда
		Возврат 0;
	КонецЕсли;

	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

	ОбщаяСебестоимость = 0;

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл

		// Получаем цену ингредиента
		ЦенаЗаКг = ПолучитьЦенуИнгредиента(
			ВыборкаДетальныеЗаписи.Ингредиент,
			ВыборкаДетальныеЗаписи.ЦенаИнгредиента
		);

		// Рассчитываем стоимость ингредиента в рецепте
		// НормаБрутто в граммах, цена за килограмм
		СтоимостьИнгредиента = (ВыборкаДетальныеЗаписи.НормаБрутто / 1000) * ЦенаЗаКг;

		ОбщаяСебестоимость = ОбщаяСебестоимость + СтоимостьИнгредиента;

	КонецЦикла;

	Возврат ОбщаяСебестоимость;

КонецФункции

// Получить цену ингредиента из справочника цен
//
// Параметры:
//  Ингредиент - СправочникСсылка.Номенклатура - Ингредиент
//  ЦенаИнгредиента - СправочникСсылка.ЦеныНаИнгредиенты - Ссылка на цену (необязательно)
//
// Возвращаемое значение:
//  Число - Цена за килограмм
//
Функция ПолучитьЦенуИнгредиента(Ингредиент, ЦенаИнгредиента = Неопределено) Экспорт

	Если НЕ ЗначениеЗаполнено(Ингредиент) Тогда
		Возврат 0;
	КонецЕсли;

	// Если указана конкретная цена, используем её
	Если ЗначениеЗаполнено(ЦенаИнгредиента) Тогда
		Возврат ЦенаИнгредиента.ЦенаЗаЕдиницу;
	КонецЕсли;

	// Иначе ищем активную цену для данного ингредиента
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЦеныНаИнгредиенты.ЦенаЗаЕдиницу КАК ЦенаЗаЕдиницу,
	|	ЦеныНаИнгредиенты.ЕдиницаИзмерения КАК ЕдиницаИзмерения
	|ИЗ
	|	Справочник.ЦеныНаИнгредиенты КАК ЦеныНаИнгредиенты
	|ГДЕ
	|	ЦеныНаИнгредиенты.Ингредиент = &Ингредиент
	|	И ЦеныНаИнгредиенты.Активность = ИСТИНА
	|	И НЕ ЦеныНаИнгредиенты.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЦеныНаИнгредиенты.ДатаУстановкиЦены УБЫВ";

	Запрос.УстановитьПараметр("Ингредиент", Ингредиент);

	РезультатЗапроса = Запрос.Выполнить();

	Если РезультатЗапроса.Пустой() Тогда
		Возврат 0;
	КонецЕсли;

	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();

	// Приводим цену к килограммам (если единица измерения не кг)
	ЦенаЗаКг = ПривестиЦенуККилограммам(Выборка.ЦенаЗаЕдиницу, Выборка.ЕдиницаИзмерения);

	Возврат ЦенаЗаКг;

КонецФункции

// Автоматически обновить цены в строках техкарточки
//
// Параметры:
//  ТехКарточкаОбъект - СправочникОбъект.Техкарточки - Объект технологической карты
//
Процедура ОбновитьЦеныВТехКарточке(ТехКарточкаОбъект) Экспорт

	Для Каждого СтрокаИнгредиент Из ТехКарточкаОбъект.СоставИнгредиентов Цикл

		// Получаем актуальную цену
		ЦенаЗаКг = ПолучитьЦенуИнгредиента(СтрокаИнгредиент.Ингредиент, СтрокаИнгредиент.ЦенаИнгредиента);

		// Обновляем цену в строке
		СтрокаИнгредиент.СтоимостьЕдиницы = ЦенаЗаКг;

		// Рассчитываем общую стоимость ингредиента в рецепте
		СтрокаИнгредиент.СуммаСтоимости = (СтрокаИнгредиент.НормаБрутто / 1000) * ЦенаЗаКг;

	КонецЦикла;

	// Рассчитываем общую себестоимость порции
	ТехКарточкаОбъект.СебестоимостьПорции = РассчитатьОбщуюСебестоимость(ТехКарточкаОбъект);

КонецПроцедуры

// Обновить цены во всех технологических картах, использующих ингредиент
//
// Параметры:
//  Ингредиент - СправочникСсылка.Номенклатура - Ингредиент
//
Процедура ОбновитьЦеныПоИнгредиенту(Ингредиент) Экспорт

	Если НЕ ЗначениеЗаполнено(Ингредиент) Тогда
		Возврат;
	КонецЕсли;

	// Находим все техкарточки, использующие данный ингредиент
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТехкарточкиСоставИнгредиентов.Ссылка КАК ТехКарточка
	|ИЗ
	|	Справочник.Техкарточки.СоставИнгредиентов КАК ТехкарточкиСоставИнгредиентов
	|ГДЕ
	|	ТехкарточкиСоставИнгредиентов.Ингредиент = &Ингредиент
	|	И НЕ ТехкарточкиСоставИнгредиентов.Ссылка.ПометкаУдаления";

	Запрос.УстановитьПараметр("Ингредиент", Ингредиент);

	РезультатЗапроса = Запрос.Выполнить();

	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;

	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл

		ТехКарточкаОбъект = ВыборкаДетальныеЗаписи.ТехКарточка.ПолучитьОбъект();

		Если ТехКарточкаОбъект <> Неопределено Тогда
			ОбновитьЦеныВТехКарточке(ТехКарточкаОбъект);

			Попытка
				ТехКарточкаОбъект.Записать();
			Исключение
				// Логируем ошибку, но продолжаем обработку
				ЗаписьЖурналаРегистрации("Обновление цен",
					УровеньЖурналаРегистрации.Ошибка,
					,
					ВыборкаДетальныеЗаписи.ТехКарточка,
					"Ошибка при обновлении цен в техкарточке: " + ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;

	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Рассчитать общую себестоимость порции
//
// Параметры:
//  ТехКарточкаОбъект - СправочникОбъект.Техкарточки
//
// Возвращаемое значение:
//  Число - Общая себестоимость порции
//
Функция РассчитатьОбщуюСебестоимость(ТехКарточкаОбъект)

	ОбщаяСебестоимость = 0;

	Для Каждого СтрокаИнгредиент Из ТехКарточкаОбъект.СоставИнгредиентов Цикл
		ОбщаяСебестоимость = ОбщаяСебестоимость + СтрокаИнгредиент.СуммаСтоимости;
	КонецЦикла;

	Возврат ОбщаяСебестоимость;

КонецФункции

// Привести цену к килограммам
//
// Параметры:
//  ЦенаЗаЕдиницу - Число - Цена за единицу измерения
//  ЕдиницаИзмерения - СправочникСсылка.КлассификаторЕдиницИзмерения - Единица измерения
//
// Возвращаемое значение:
//  Число - Цена за килограмм
//
Функция ПривестиЦенуККилограммам(ЦенаЗаЕдиницу, ЕдиницаИзмерения)

	Если НЕ ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
		// Если единица измерения не указана, считаем что цена за кг
		Возврат ЦенаЗаЕдиницу;
	КонецЕсли;

	// Получаем коэффициент перевода в килограммы
	КоэффициентПеревода = ПолучитьКоэффициентПереводаВКилограммы(ЕдиницаИзмерения);

	Если КоэффициентПеревода = 0 Тогда
		Возврат ЦенаЗаЕдиницу; // Возвращаем исходную цену, если не можем перевести
	КонецЕсли;

	Возврат ЦенаЗаЕдиницу / КоэффициентПеревода;

КонецФункции

// Получить коэффициент перевода единицы измерения в килограммы
//
// Параметры:
//  ЕдиницаИзмерения - СправочникСсылка.КлассификаторЕдиницИзмерения
//
// Возвращаемое значение:
//  Число - Коэффициент перевода (1 кг = ? единиц)
//
Функция ПолучитьКоэффициентПереводаВКилограммы(ЕдиницаИзмерения)

	// Получаем код единицы измерения
	КодЕдиницы = СокрЛП(ВРег(ЕдиницаИзмерения.Код));

	// Стандартные коэффициенты перевода
	Если КодЕдиницы = "166" ИЛИ КодЕдиницы = "КГ" Тогда
		Возврат 1; // килограмм
	ИначеЕсли КодЕдиницы = "163" ИЛИ КодЕдиницы = "Г" Тогда
		Возврат 1000; // грамм
	ИначеЕсли КодЕдиницы = "113" ИЛИ КодЕдиницы = "Т" Тогда
		Возврат 0.001; // тонна
	ИначеЕсли КодЕдиницы = "112" ИЛИ КодЕдиницы = "Л" Тогда
		Возврат 1; // литр (приблизительно равен кг для воды)
	Иначе
		// Для неизвестных единиц возвращаем 1 (считаем что цена уже в кг)
		Возврат 1;
	КонецЕсли;

КонецФункции

#КонецОбласти
```

---

## СОЗДАНИЕ МОДУЛЕЙ МЕНЕДЖЕРОВ

### Шаг 4.1: Модуль менеджера справочника "Техкарточки"

1. Откройте справочник **"Техкарточки"**
2. Перейдите на закладку **"Модули"**
3. Дважды щелкните на **"Модуль менеджера"**
4. Вставьте следующий код:

```bsl
////////////////////////////////////////////////////////////////////////////////
// МОДУЛЬ МЕНЕДЖЕРА СПРАВОЧНИКА "ТЕХКАРТОЧКИ"
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытий

// Обработчик события ОбработкаЗаполнения
//
// Параметры:
//  Объект - СправочникОбъект.Техкарточки - Заполняемый объект
//  ДанныеЗаполнения - Произвольный - Данные для заполнения
//  СтандартнаяОбработка - Булево - Признак выполнения стандартной обработки события
//
Процедура ОбработкаЗаполнения(Объект, ДанныеЗаполнения, СтандартнаяОбработка) Экспорт

	// При создании новой техкарточки обновляем цены
	РасчетСебестоимости.ОбновитьЦеныВТехКарточке(Объект);

КонецПроцедуры

// Обработчик события ПередЗаписью
//
// Параметры:
//  Объект - СправочникОбъект.Техкарточки - Записываемый объект
//  Отказ - Булево - Признак отказа от записи
//
Процедура ПередЗаписью(Объект, Отказ) Экспорт

	// Обновляем цены и пересчитываем себестоимость перед записью
	РасчетСебестоимости.ОбновитьЦеныВТехКарточке(Объект);

КонецПроцедуры

#КонецОбласти
```

### Шаг 4.2: Модуль менеджера справочника "ЦеныНаИнгредиенты"

1. Откройте справочник **"ЦеныНаИнгредиенты"**
2. Перейдите на закладку **"Модули"**
3. Создайте **"Модуль менеджера"** (если его нет)
4. Вставьте следующий код:

```bsl
////////////////////////////////////////////////////////////////////////////////
// МОДУЛЬ МЕНЕДЖЕРА СПРАВОЧНИКА "ЦЕНЫ НА ИНГРЕДИЕНТЫ"
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытий

// Обработчик события ПередЗаписью
//
// Параметры:
//  Объект - СправочникОбъект.ЦеныНаИнгредиенты - Записываемый объект
//  Отказ - Булево - Признак отказа от записи
//
Процедура ПередЗаписью(Объект, Отказ) Экспорт

	// При изменении цены запоминаем старое значение для истории
	Если НЕ Объект.ЭтоНовый() И Объект.ЦенаЗаЕдиницу <> Объект.Ссылка.ЦенаЗаЕдиницу Тогда

		// Добавляем запись в историю изменений
		НоваяСтрокаИстории = Объект.ИсторияЦен.Добавить();
		НоваяСтрокаИстории.ДатаИзменения = ТекущаяДата();
		НоваяСтрокаИстории.СтараяЦена = Объект.Ссылка.ЦенаЗаЕдиницу;
		НоваяСтрокаИстории.НоваяЦена = Объект.ЦенаЗаЕдиницу;
		НоваяСтрокаИстории.ПричинаИзменения = "Изменение цены";

	КонецЕсли;

	// Устанавливаем дату установки цены
	Если НЕ ЗначениеЗаполнено(Объект.ДатаУстановкиЦены) Тогда
		Объект.ДатаУстановкиЦены = ТекущаяДата();
	КонецЕсли;

КонецПроцедуры

// Обработчик события ПриЗаписи
//
// Параметры:
//  Объект - СправочникОбъект.ЦеныНаИнгредиенты - Записанный объект
//  Отказ - Булево - Признак отказа от записи
//
Процедура ПриЗаписи(Объект, Отказ) Экспорт

	// После изменения цены обновляем все техкарточки с этим ингредиентом
	Если ЗначениеЗаполнено(Объект.Ингредиент) Тогда
		РасчетСебестоимости.ОбновитьЦеныПоИнгредиенту(Объект.Ингредиент);
	КонецЕсли;

КонецПроцедуры

#КонецОбласти
```

---

## МОДИФИКАЦИЯ ФОРМ

### Шаг 5.1: Изменение формы справочника "Техкарточки"

#### 5.1.1 Добавление новой колонки в табличное поле

1. Откройте справочник **"Техкарточки"**
2. Перейдите на закладку **"Формы"**
3. Откройте **"Форма элемента"**
4. Найдите в дереве элементов табличное поле **"СоставИнгредиентов"**
5. Раскройте его и найдите колонки
6. Правой кнопкой на колонках → **"Добавить"** → **"Поле ввода"**

#### 5.1.2 Настройка новой колонки

1. Выберите созданную колонку
2. В окне свойств установите:
   ```
   Имя: СоставИнгредиентовЦенаИнгредиента
   Путь к данным: Объект.СоставИнгредиентов.ЦенаИнгредиента
   Заголовок: Цена ингредиента
   Вид: Поле ввода
   ```
3. **ВАЖНО:** Переместите эту колонку так, чтобы она располагалась ПЕРЕД колонкой "СтоимостьЕдиницы"

#### 5.1.3 Изменение существующей колонки "СтоимостьЕдиницы"

1. Выберите колонку **"СоставИнгредиентовСтоимостьЕдиницы"**
2. Измените свойства:
   ```
   Заголовок: Цена за кг (авто)
   Только просмотр: Да
   ```

#### 5.1.4 Добавление обработчиков событий в модуль формы

1. В форме техкарточки откройте **"Модуль формы"**
2. Добавьте следующие процедуры:

```bsl
&НаКлиенте
Процедура СоставИнгредиентовЦенаИнгредиентаПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Заполняем цену при выборе
	Если ЗначениеЗаполнено(ТекущаяСтрока.ЦенаИнгредиента) Тогда
		ТекущаяСтрока.СтоимостьЕдиницы = ТекущаяСтрока.ЦенаИнгредиента.ЦенаЗаЕдиницу;

		// Пересчитываем сумму
		ТекущаяСтрока.СуммаСтоимости = (ТекущаяСтрока.НормаБрутто / 1000) * ТекущаяСтрока.СтоимостьЕдиницы;

		// Обновляем общую себестоимость
		ОбновитьСебестоимостьПорцииНаСервере();
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовИнгредиентПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Очищаем поле цены при изменении ингредиента
	ТекущаяСтрока.ЦенаИнгредиента = Справочники.ЦеныНаИнгредиенты.ПустаяСсылка();
	ТекущаяСтрока.СтоимостьЕдиницы = 0;
	ТекущаяСтрока.СуммаСтоимости = 0;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовНормаБруттоПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Пересчитываем сумму при изменении нормы
	ТекущаяСтрока.СуммаСтоимости = (ТекущаяСтрока.НормаБрутто / 1000) * ТекущаяСтрока.СтоимостьЕдиницы;

	// Обновляем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

&НаСервере
Процедура ОбновитьСебестоимостьПорцииНаСервере()

	РасчетСебестоимости.ОбновитьЦеныВТехКарточке(Объект);

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьВсеЦены(Команда)

	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры
```

#### 5.1.5 Добавление команды "Обновить цены"

1. В форме техкарточки найдите узел **"Команды"**
2. Правой кнопкой → **"Добавить"**
3. Настройте команду:
   ```
   Имя: ОбновитьВсеЦены
   Заголовок: Обновить цены
   Подсказка: Обновить цены из справочника
   Действие: ОбновитьВсеЦены
   ```

4. Добавьте кнопку на командную панель:
   - Найдите **"Командная панель формы"**
   - Правой кнопкой → **"Добавить"** → **"Кнопка"**
   - Имя команды: **ОбновитьВсеЦены**

### Шаг 5.2: Создание формы для справочника "ЦеныНаИнгредиенты"

#### 5.2.1 Создание формы элемента

1. Откройте справочник **"ЦеныНаИнгредиенты"**
2. На закладке **"Формы"** → правой кнопкой → **"Добавить"**
3. Тип формы: **"Форма элемента"**
4. Имя: **"ФормаЭлемента"**

#### 5.2.2 Размещение элементов на форме

1. Откройте созданную форму
2. Добавьте поля в следующем порядке:

**Группа "Основные данные":**
```
- Поле "Ингредиент" (Объект.Ингредиент)
- Поле "Единица измерения" (Объект.ЕдиницаИзмерения)
- Поле "Цена за единицу" (Объект.ЦенаЗаЕдиницу)
- Поле "Дата установки цены" (Объект.ДатаУстановкиЦены)
```

**Группа "Дополнительные данные":**
```
- Поле "Поставщик" (Объект.Поставщик)
- Поле "Активность" (Объект.Активность)
- Поле "Комментарий" (Объект.Комментарий)
```

**Табличное поле "История цен":**
```
- Путь к данным: Объект.ИсторияЦен
- Колонки:
  - ДатаИзменения
  - СтараяЦена
  - НоваяЦена
  - ПричинаИзменения
```

---

## СОЗДАНИЕ ДОПОЛНИТЕЛЬНЫХ ЭЛЕМЕНТОВ

### Шаг 6.1: Создание перечисления "РежимыОбновленияЦен"

1. В дереве метаданных найдите **"Перечисления"**
2. Правой кнопкой → **"Добавить"**
3. Заполните:
   ```
   Имя: РежимыОбновленияЦен
   Синоним: Режимы обновления цен
   Комментарий: Перечисление режимов обновления цен в технологических картах
   ```

4. Добавьте значения перечисления:

**Значение "ВсеТехкарточки":**
```
Имя: ВсеТехкарточки
Синоним: Все технологические карты
Комментарий: Обновить цены во всех технологических картах
```

**Значение "ПоИнгредиенту":**
```
Имя: ПоИнгредиенту
Синоним: По конкретному ингредиенту
Комментарий: Обновить цены только для выбранного ингредиента
```

**Значение "ПоКатегории":**
```
Имя: ПоКатегории
Синоним: По категории блюд
Комментарий: Обновить цены для техкарточек определенной категории
```

### Шаг 6.2: Создание обработки "ОбновлениеЦенВТехКарточках"

#### 6.2.1 Создание обработки

1. В дереве метаданных найдите **"Обработки"**
2. Правой кнопкой → **"Добавить"**
3. Заполните:
   ```
   Имя: ОбновлениеЦенВТехКарточках
   Синоним: Обновление цен в технологических картах
   Комментарий: Обработка для массового обновления цен во всех технологических картах
   ```

#### 6.2.2 Добавление реквизитов

**Реквизит "РежимОбновления":**
```
Имя: РежимОбновления
Синоним: Режим обновления
Тип: ПеречислениеСсылка.РежимыОбновленияЦен
```

**Реквизит "ВыбранныйИнгредиент":**
```
Имя: ВыбранныйИнгредиент
Синоним: Выбранный ингредиент
Тип: СправочникСсылка.Номенклатура
```

**Реквизит "КоличествоОбновленных":**
```
Имя: КоличествоОбновленных
Синоним: Количество обновленных
Тип: Число (10,0)
Только просмотр: Да
```

**Реквизит "КоличествоОшибок":**
```
Имя: КоличествоОшибок
Синоним: Количество ошибок
Тип: Число (10,0)
Только просмотр: Да
```

#### 6.2.3 Создание табличной части "РезультатОбработки"

1. Добавьте табличную часть:
   ```
   Имя: РезультатОбработки
   Синоним: Результат обработки
   ```

2. Добавьте колонки:

**ТехКарточка:**
```
Имя: ТехКарточка
Синоним: Техкарточка
Тип: СправочникСсылка.Техкарточки
```

**СтатусОбработки:**
```
Имя: СтатусОбработки
Синоним: Статус
Тип: Строка (50)
```

**СтараяСебестоимость:**
```
Имя: СтараяСебестоимость
Синоним: Старая себестоимость
Тип: Число (15,2)
```

**НоваяСебестоимость:**
```
Имя: НоваяСебестоимость
Синоним: Новая себестоимость
Тип: Число (15,2)
```

**ТекстОшибки:**
```
Имя: ТекстОшибки
Синоним: Текст ошибки
Тип: Строка (500)
```

#### 6.2.4 Создание модуля объекта обработки

1. Перейдите на закладку **"Модули"**
2. Создайте **"Модуль объекта"**
3. Вставьте следующий код:

```bsl
////////////////////////////////////////////////////////////////////////////////
// МОДУЛЬ ОБЪЕКТА ОБРАБОТКИ "ОБНОВЛЕНИЕ ЦЕН В ТЕХНОЛОГИЧЕСКИХ КАРТАХ"
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Выполнить обновление цен
//
Процедура ВыполнитьОбновлениеЦен() Экспорт

	// Очищаем результат предыдущего выполнения
	РезультатОбработки.Очистить();
	КоличествоОбновленных = 0;
	КоличествоОшибок = 0;

	// Получаем список техкарточек для обработки
	СписокТехкарточек = ПолучитьСписокТехкарточекДляОбновления();

	Если СписокТехкарточек.Количество() = 0 Тогда
		Сообщить("Не найдено техкарточек для обновления");
		Возврат;
	КонецЕсли;

	// Обрабатываем каждую техкарточку
	Для Каждого СтрокаТехкарточки Из СписокТехкарточек Цикл

		ОбработатьТехкарточку(СтрокаТехкарточки.ТехКарточка);

	КонецЦикла;

	// Выводим итоговое сообщение
	Сообщить(СтрШаблон("Обработка завершена. Обновлено: %1, ошибок: %2",
		КоличествоОбновленных, КоличествоОшибок));

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Получить список техкарточек для обновления
//
// Возвращаемое значение:
//  ТаблицаЗначений - Список техкарточек
//
Функция ПолучитьСписокТехкарточекДляОбновления()

	Запрос = Новый Запрос;

	Если РежимОбновления = Перечисления.РежимыОбновленияЦен.ВсеТехкарточки Тогда

		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Техкарточки.Ссылка КАК ТехКарточка
		|ИЗ
		|	Справочник.Техкарточки КАК Техкарточки
		|ГДЕ
		|	НЕ Техкарточки.ПометкаУдаления";

	ИначеЕсли РежимОбновления = Перечисления.РежимыОбновленияЦен.ПоИнгредиенту Тогда

		Если НЕ ЗначениеЗаполнено(ВыбранныйИнгредиент) Тогда
			Возврат Новый ТаблицаЗначений;
		КонецЕсли;

		Запрос.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТехкарточкиСоставИнгредиентов.Ссылка КАК ТехКарточка
		|ИЗ
		|	Справочник.Техкарточки.СоставИнгредиентов КАК ТехкарточкиСоставИнгредиентов
		|ГДЕ
		|	ТехкарточкиСоставИнгредиентов.Ингредиент = &ВыбранныйИнгредиент
		|	И НЕ ТехкарточкиСоставИнгредиентов.Ссылка.ПометкаУдаления";

		Запрос.УстановитьПараметр("ВыбранныйИнгредиент", ВыбранныйИнгредиент);

	Иначе
		Возврат Новый ТаблицаЗначений;
	КонецЕсли;

	РезультатЗапроса = Запрос.Выполнить();

	Возврат РезультатЗапроса.Выгрузить();

КонецФункции

// Обработать техкарточку
//
// Параметры:
//  ТехКарточка - СправочникСсылка.Техкарточки - Техкарточка для обработки
//
Процедура ОбработатьТехкарточку(ТехКарточка)

	НоваяСтрокаРезультата = РезультатОбработки.Добавить();
	НоваяСтрокаРезультата.ТехКарточка = ТехКарточка;

	Попытка

		// Запоминаем старую себестоимость
		НоваяСтрокаРезультата.СтараяСебестоимость = ТехКарточка.СебестоимостьПорции;

		// Получаем объект техкарточки
		ТехКарточкаОбъект = ТехКарточка.ПолучитьОбъект();

		Если ТехКарточкаОбъект = Неопределено Тогда
			НоваяСтрокаРезультата.СтатусОбработки = "Ошибка";
			НоваяСтрокаРезультата.ТекстОшибки = "Не удалось получить объект техкарточки";
			КоличествоОшибок = КоличествоОшибок + 1;
			Возврат;
		КонецЕсли;

		// Обновляем цены
		РасчетСебестоимости.ОбновитьЦеныВТехКарточке(ТехКарточкаОбъект);

		// Записываем изменения
		ТехКарточкаОбъект.Записать();

		// Фиксируем результат
		НоваяСтрокаРезультата.НоваяСебестоимость = ТехКарточкаОбъект.СебестоимостьПорции;
		НоваяСтрокаРезультата.СтатусОбработки = "Успешно";
		КоличествоОбновленных = КоличествоОбновленных + 1;

	Исключение

		НоваяСтрокаРезультата.СтатусОбработки = "Ошибка";
		НоваяСтрокаРезультата.ТекстОшибки = ОписаниеОшибки();
		КоличествоОшибок = КоличествоОшибок + 1;

	КонецПопытки;

КонецПроцедуры

#КонецОбласти
```

#### 6.2.5 Создание формы обработки

1. На закладке **"Формы"** → правой кнопкой → **"Добавить"**
2. Тип формы: **"Основная форма"**
3. Имя: **"Форма"**

4. Разместите на форме следующие элементы:

**Группа "Параметры обновления":**
```
- Поле "Режим обновления" (РежимОбновления)
- Поле "Выбранный ингредиент" (ВыбранныйИнгредиент)
```

**Группа "Результаты":**
```
- Поле "Количество обновленных" (КоличествоОбновленных)
- Поле "Количество ошибок" (КоличествоОшибок)
```

**Табличное поле "Результат обработки":**
```
- Путь к данным: Объект.РезультатОбработки
- Все колонки табличной части
```

**Команды:**
```
- Кнопка "Выполнить обновление" → команда ВыполнитьОбновление
```

5. Добавьте в модуль формы:

```bsl
&НаКлиенте
Процедура ВыполнитьОбновление(Команда)

	Если НЕ ЗначениеЗаполнено(Объект.РежимОбновления) Тогда
		Сообщить("Выберите режим обновления");
		Возврат;
	КонецЕсли;

	Если Объект.РежимОбновления = ПредопределенноеЗначение("Перечисление.РежимыОбновленияЦен.ПоИнгредиенту")
		И НЕ ЗначениеЗаполнено(Объект.ВыбранныйИнгредиент) Тогда
		Сообщить("При обновлении по ингредиенту необходимо выбрать ингредиент");
		Возврат;
	КонецЕсли;

	Объект.ВыполнитьОбновлениеЦен();

КонецПроцедуры

&НаКлиенте
Процедура РежимОбновленияПриИзменении(Элемент)

	// Управляем доступностью поля выбора ингредиента
	Если Объект.РежимОбновления = ПредопределенноеЗначение("Перечисление.РежимыОбновленияЦен.ПоИнгредиенту") Тогда
		Элементы.ВыбранныйИнгредиент.Доступность = Истина;
	Иначе
		Элементы.ВыбранныйИнгредиент.Доступность = Ложь;
		Объект.ВыбранныйИнгредиент = ПредопределенноеЗначение("Справочник.Номенклатура.ПустаяСсылка");
	КонецЕсли;

КонецПроцедуры
```

---

## ОБНОВЛЕНИЕ БАЗЫ ДАННЫХ

### Шаг 7.1: Сохранение конфигурации

1. Нажмите **Ctrl+S** или меню **"Файл"** → **"Сохранить"**
2. Убедитесь что все изменения сохранены без ошибок

### Шаг 7.2: Обновление структуры базы данных

1. В меню выберите **"Конфигурация"** → **"Обновить конфигурацию базы данных"**
2. В появившемся диалоге:
   - Установите флажок **"Реструктуризировать таблицы"**
   - Нажмите **"Выполнить"**

3. Система покажет список изменений:
   - Новые справочники
   - Новые реквизиты
   - Изменения в существующих объектах

4. Нажмите **"Да"** для подтверждения обновления

### Шаг 7.3: Проверка успешного обновления

1. После завершения обновления откройте режим **"Предприятие"**
2. Проверьте наличие:
   - Справочника **"Цены на ингредиенты"**
   - Новых полей в техкарточках
   - Обработки **"Обновление цен в технологических картах"**

---

## ПЕРВОНАЧАЛЬНОЕ ЗАПОЛНЕНИЕ

### Шаг 8.1: Создание цен на ингредиенты

1. Откройте справочник **"Цены на ингредиенты"**
2. Для каждого ингредиента создайте запись:

**Пример заполнения записи:**
```
Наименование: Мука пшеничная в/с
Ингредиент: [выберите из номенклатуры]
Единица измерения: кг
Цена за единицу: 45.50
Дата установки цены: [текущая дата]
Поставщик: [если известен]
Активность: Да
Комментарий: Цена актуальна с [дата]
```

### Шаг 8.2: Заполнение справочника цен

**Рекомендуемый порядок:**

1. **Основные ингредиенты:**
   - Мука (пшеничная, ржаная)
   - Сахар
   - Соль
   - Масло растительное
   - Масло сливочное

2. **Мясные продукты:**
   - Говядина
   - Свинина
   - Курица
   - Рыба

3. **Молочные продукты:**
   - Молоко
   - Сметана
   - Творог
   - Сыр

4. **Овощи и фрукты:**
   - Картофель
   - Морковь
   - Лук
   - Помидоры
   - Яблоки

### Шаг 8.3: Обновление существующих техкарточек

1. Откройте обработку **"Обновление цен в технологических картах"**
2. Выберите режим **"Все технологические карты"**
3. Нажмите **"Выполнить обновление"**

**ИЛИ**

1. Откройте каждую техкарточку вручную
2. В составе ингредиентов:
   - Выберите соответствующую цену в поле **"Цена ингредиента"**
   - Поле **"Цена за кг (авто)"** заполнится автоматически
   - Будет рассчитана сумма стоимости
3. Сохраните техкарточку

---

## ТЕСТИРОВАНИЕ СИСТЕМЫ

### Шаг 9.1: Тестирование создания цены

1. **Создание новой цены:**
   - Откройте справочник **"Цены на ингредиенты"**
   - Создайте новую запись
   - Заполните все обязательные поля
   - Сохраните запись
   - ✅ **Результат:** Запись должна сохраниться без ошибок

### Шаг 9.2: Тестирование автоматического заполнения

1. **Проверка заполнения цены в техкарточке:**
   - Откройте любую техкарточку
   - В составе ингредиентов выберите строку
   - В поле **"Цена ингредиента"** выберите созданную цену
   - ✅ **Результат:** Поле **"Цена за кг (авто)"** должно заполниться автоматически
   - ✅ **Результат:** Поле **"Сумма"** должно пересчитаться
   - ✅ **Результат:** Поле **"Себестоимость порции"** должно обновиться

### Шаг 9.3: Тестирование изменения цены

1. **Проверка обновления при изменении цены:**
   - Откройте запись в справочнике цен
   - Измените цену (например, увеличьте на 10%)
   - Сохраните запись
   - ✅ **Результат:** В истории цен должна появиться запись об изменении
   - ✅ **Результат:** Все техкарточки с этим ингредиентом должны обновиться автоматически

### Шаг 9.4: Тестирование массового обновления

1. **Проверка обработки массового обновления:**
   - Откройте обработку **"Обновление цен в технологических картах"**
   - Выберите режим **"По конкретному ингредиенту"**
   - Выберите тестовый ингредиент
   - Нажмите **"Выполнить обновление"**
   - ✅ **Результат:** Обработка должна выполниться без ошибок
   - ✅ **Результат:** В результатах должны отображаться обработанные техкарточки

### Шаг 9.5: Тестирование расчета себестоимости

1. **Проверка корректности расчетов:**

   **Пример расчета:**
   ```
   Ингредиент: Мука
   Норма брутто: 500 г
   Цена за кг: 50 руб
   Ожидаемая стоимость: (500/1000) × 50 = 25 руб
   ```

   - Создайте тестовую техкарточку с известными данными
   - Рассчитайте ожидаемую себестоимость вручную
   - Сравните с автоматически рассчитанной
   - ✅ **Результат:** Значения должны совпадать

### Шаг 9.6: Проверка истории изменений

1. **Проверка ведения истории:**
   - Откройте запись в справочнике цен
   - Несколько раз измените цену с разными комментариями
   - Откройте табличную часть **"История изменения цен"**
   - ✅ **Результат:** Каждое изменение должно быть зафиксировано
   - ✅ **Результат:** Дата, старая цена, новая цена должны быть корректными

### Шаг 9.7: Проверка производительности

1. **Тестирование на больших объемах:**
   - Создайте 100+ записей в справочнике цен
   - Создайте 50+ техкарточек с множественными ингредиентами
   - Выполните массовое обновление всех техкарточек
   - ✅ **Результат:** Операция должна выполниться за разумное время (до 5-10 минут)

---

## ВОЗМОЖНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### Проблема 1: Ошибка при обновлении базы данных

**Симптомы:** Ошибка "Нарушение уникальности индекса"

**Решение:**
1. Проверьте уникальность кодов в справочниках
2. Удалите дублирующиеся записи
3. Повторите обновление базы данных

### Проблема 2: Цены не обновляются автоматически

**Симптомы:** При изменении цены техкарточки не обновляются

**Решение:**
1. Проверьте правильность кода в модуле менеджера справочника "ЦеныНаИнгредиенты"
2. Убедитесь что процедура `ПриЗаписи` вызывается
3. Проверьте права доступа к справочнику "Техкарточки"

### Проблема 3: Неправильный расчет себестоимости

**Симптомы:** Себестоимость рассчитывается некорректно

**Решение:**
1. Проверьте единицы измерения в справочнике цен (должны быть кг, л, г)
2. Убедитесь что нормы указаны в граммах
3. Проверьте функцию `ПривестиЦенуККилограммам`

### Проблема 4: Ошибки доступа при массовом обновлении

**Симптомы:** "Недостаточно прав для изменения объекта"

**Решение:**
1. Проверьте права роли на справочник "Техкарточки"
2. Добавьте права "Изменение" и "Запись"

### Проблема 5: Форма не отображает новые поля

**Симптомы:** Новые поля не видны в форме техкарточки

**Решение:**
1. Обновите конфигурацию базы данных
2. Пересоздайте форму автоматически
3. Проверьте правильность привязки полей к данным

---

## ДОПОЛНИТЕЛЬНЫЕ РЕКОМЕНДАЦИИ

### Резервное копирование
- Создавайте резервные копии еженедельно
- Перед массовыми операциями всегда делайте backup

### Мониторинг системы
- Регулярно проверяйте журнал регистрации на предмет ошибок
- Контролируйте актуальность цен в справочнике

### Развитие системы
- Добавьте возможность ведения цен по датам
- Реализуйте импорт цен из внешних систем
- Создайте отчеты по динамике себестоимости

### Обучение пользователей
- Проведите обучение персонала работе с новой системой
- Создайте инструкции для конечных пользователей
- Организуйте техническую поддержку

---

**СИСТЕМА ГОТОВА К РАБОТЕ!**

После выполнения всех шагов у вас будет полноценная система централизованного управления ценами на ингредиенты с автоматическим расчетом себестоимости блюд.