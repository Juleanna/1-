// ИСПРАВЛЕННЫЙ КОД ДЛЯ МОДУЛЯ ФОРМЫ СПРАВОЧНИКА "ТЕХКАРТОЧКИ"
// С правильными серверными вызовами

&НаКлиенте
Процедура СоставИнгредиентовЦенаИнгредиентаПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Заполняем цену при выборе (серверный вызов)
	Если ЗначениеЗаполнено(ТекущаяСтрока.ЦенаИнгредиента) Тогда

		ЦенаЗаКг = ПолучитьЦенуИнгредиентаНаСервере(ТекущаяСтрока.Ингредиент, ТекущаяСтрока.ЦенаИнгредиента);

		ТекущаяСтрока.СтоимостьЕдиницы = ЦенаЗаКг;

		// Пересчитываем сумму
		Если ТекущаяСтрока.НормаБрутто > 0 Тогда
			ТекущаяСтрока.СуммаСтоимости = (ТекущаяСтрока.НормаБрутто / 1000) * ТекущаяСтрока.СтоимостьЕдиницы;
		Иначе
			ТекущаяСтрока.СуммаСтоимости = 0;
		КонецЕсли;

		// Обновляем общую себестоимость
		ОбновитьСебестоимостьПорцииНаСервере();
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовИнгредиентПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Очищаем поля цены при изменении ингредиента
	ТекущаяСтрока.ЦенаИнгредиента = ПредопределенноеЗначение("Справочник.ЦеныНаИнгредиенты.ПустаяСсылка");
	ТекущаяСтрока.СтоимостьЕдиницы = 0;
	ТекущаяСтрока.СуммаСтоимости = 0;

	// Обновляем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовНормаБруттоПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Пересчитываем сумму при изменении нормы
	Если ТекущаяСтрока.НормаБрутто > 0 Тогда
		ТекущаяСтрока.СуммаСтоимости = (ТекущаяСтрока.НормаБрутто / 1000) * ТекущаяСтрока.СтоимостьЕдиницы;
	Иначе
		ТекущаяСтрока.СуммаСтоимости = 0;
	КонецЕсли;

	// Обновляем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

// СЕРВЕРНЫЕ ПРОЦЕДУРЫ

&НаСервере
Функция ПолучитьЦенуИнгредиентаНаСервере(Ингредиент, ЦенаИнгредиента)

	Возврат РасчетСебестоимостиМодуль.ПолучитьЦенуИнгредиентаДляФормы(Ингредиент, ЦенаИнгредиента);

КонецФункции

&НаСервере
Процедура ОбновитьСебестоимостьПорцииНаСервере()

	РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьВсеЦены(Команда)

	ОбновитьСебестоимостьПорцииНаСервере();
	Сообщить("Цены обновлены из справочника");

КонецПроцедуры

&НаКлиенте
Процедура АвтозаполнениеЦенИнгредиентов(Команда)

	КоличествоОбновленных = АвтозаполнениеЦенИнгредиентовНаСервере();

	Если КоличествоОбновленных > 0 Тогда
		Сообщить(СтрШаблон("Автоматически заполнено цен: %1", КоличествоОбновленных));
	Иначе
		Сообщить("Активные цены для ингредиентов не найдены");
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция АвтозаполнениеЦенИнгредиентовНаСервере()

	КоличествоОбновленных = 0;

	Для Каждого СтрокаИнгредиент Из Объект.СоставИнгредиентов Цикл

		Если ЗначениеЗаполнено(СтрокаИнгредиент.Ингредиент) И НЕ ЗначениеЗаполнено(СтрокаИнгредиент.ЦенаИнгредиента) Тогда

			// Ищем активную цену для ингредиента
			АктивнаяЦена = НайтиАктивнуюЦенуДляИнгредиента(СтрокаИнгредиент.Ингредиент);

			Если ЗначениеЗаполнено(АктивнаяЦена) Тогда
				СтрокаИнгредиент.ЦенаИнгредиента = АктивнаяЦена;
				КоличествоОбновленных = КоличествоОбновленных + 1;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;

	Если КоличествоОбновленных > 0 Тогда
		РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);
	КонецЕсли;

	Возврат КоличествоОбновленных;

КонецФункции

&НаСервере
Функция НайтиАктивнуюЦенуДляИнгредиента(Ингредиент)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЦеныНаИнгредиенты.Ссылка КАК ЦенаСсылка
	|ИЗ
	|	Справочник.ЦеныНаИнгредиенты КАК ЦеныНаИнгредиенты
	|ГДЕ
	|	ЦеныНаИнгредиенты.Ингредиент = &Ингредиент
	|	И ЦеныНаИнгредиенты.Активность = ИСТИНА
	|	И НЕ ЦеныНаИнгредиенты.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЦеныНаИнгредиенты.ДатаУстановкиЦены УБЫВ";

	Запрос.УстановитьПараметр("Ингредиент", Ингредиент);

	РезультатЗапроса = Запрос.Выполнить();

	Если РезультатЗапроса.Пустой() Тогда
		Возврат Справочники.ЦеныНаИнгредиенты.ПустаяСсылка();
	КонецЕсли;

	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();

	Возврат Выборка.ЦенаСсылка;

КонецФункции