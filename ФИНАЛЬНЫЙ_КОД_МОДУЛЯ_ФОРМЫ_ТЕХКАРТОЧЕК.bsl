////////////////////////////////////////////////////////////////////////////////
// ФИНАЛЬНЫЙ КОД ДЛЯ МОДУЛЯ ФОРМЫ СПРАВОЧНИКА "ТЕХКАРТОЧКИ"
// Полная версия с правильными серверными вызовами и всеми обработчиками событий
// Версия: ФИНАЛЬНАЯ - проверено и протестировано
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Инициализация формы при создании
	Если Объект.Ссылка.Пустая() Тогда
		// Для новой техкарточки автоматически обновляем цены
		РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)

	// Обновляем отображение при открытии формы
	ОбновитьОтображениеЭлементовФормы();

КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)

	// Финальный пересчет перед сохранением
	РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(ТекущийОбъект);

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыСоставИнгредиентов

&НаКлиенте
Процедура СоставИнгредиентовИнгредиентПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// При изменении ингредиента очищаем связанные поля
	ТекущаяСтрока.ЦенаИнгредиента = ПредопределенноеЗначение("Справочник.ЦеныНаИнгредиенты.ПустаяСсылка");
	ТекущаяСтрока.СтоимостьЕдиницы = 0;
	ТекущаяСтрока.СуммаСтоимости = 0;

	// Если ингредиент выбран - пытаемся найти цену автоматически
	Если ЗначениеЗаполнено(ТекущаяСтрока.Ингредиент) Тогда
		АвтоматическиЗаполнитьЦенуСтроки(ТекущаяСтрока);
	КонецЕсли;

	// Обновляем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовЦенаИнгредиентаПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Заполняем цену при выборе (серверный вызов)
	Если ЗначениеЗаполнено(ТекущаяСтрока.ЦенаИнгредиента) Тогда

		// Получаем цену с сервера
		ЦенаЗаКг = ПолучитьЦенуИнгредиентаНаСервере(ТекущаяСтрока.Ингредиент, ТекущаяСтрока.ЦенаИнгредиента);

		ТекущаяСтрока.СтоимостьЕдиницы = ЦенаЗаКг;

		// Пересчитываем стоимость ингредиента в рецепте
		РассчитатьСтоимостьИнгредиентаВСтроке(ТекущаяСтрока);

		// Обновляем общую себестоимость
		ОбновитьСебестоимостьПорцииНаСервере();

	Иначе
		// Если цена очищена - обнуляем расчеты
		ТекущаяСтрока.СтоимостьЕдиницы = 0;
		ТекущаяСтрока.СуммаСтоимости = 0;
		ОбновитьСебестоимостьПорцииНаСервере();
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовНормаБруттоПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Пересчитываем стоимость при изменении нормы
	РассчитатьСтоимостьИнгредиентаВСтроке(ТекущаяСтрока);

	// Обновляем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовНормаНеттоПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Автоматически рассчитываем процент отходов при изменении нормы нетто
	Если ТекущаяСтрока.НормаБрутто > 0 И ТекущаяСтрока.НормаНетто > 0 Тогда
		ТекущаяСтрока.ПроцентОтходов = ((ТекущаяСтрока.НормаБрутто - ТекущаяСтрока.НормаНетто) / ТекущаяСтрока.НормаБрутто) * 100;
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовПроцентОтходовПриИзменении(Элемент)

	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Автоматически рассчитываем норму нетто при изменении процента отходов
	Если ТекущаяСтрока.НормаБрутто > 0 И ТекущаяСтрока.ПроцентОтходов >= 0 Тогда
		ТекущаяСтрока.НормаНетто = ТекущаяСтрока.НормаБрутто * (1 - ТекущаяСтрока.ПроцентОтходов / 100);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)

	// Установка значений по умолчанию для новой строки
	// Выполняется автоматически через обработчик ПослеДобавленияСтроки

КонецПроцедуры

&НаКлиенте
Процедура СоставИнгредиентовПослеУдаленияСтроки(Элемент)

	// После удаления строки пересчитываем общую себестоимость
	ОбновитьСебестоимостьПорцииНаСервере();

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьВсеЦены(Команда)

	// Принудительное обновление всех цен из справочника
	ОбновитьСебестоимостьПорцииНаСервере();

	Сообщить("Цены обновлены из справочника");

КонецПроцедуры

&НаКлиенте
Процедура АвтозаполнениеЦенИнгредиентов(Команда)

	// Автоматическое заполнение цен для ингредиентов без указанных цен
	КоличествоОбновленных = АвтозаполнениеЦенИнгредиентовНаСервере();

	Если КоличествоОбновленных > 0 Тогда
		Сообщить(СтрШаблон("Автоматически заполнено цен: %1", КоличествоОбновленных));
	Иначе
		Сообщить("Активные цены для ингредиентов не найдены или уже заполнены");
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОчиститьВсеЦены(Команда)

	// Очистка всех цен в составе ингредиентов
	Если НЕ ПустаяСтрока(Объект.СоставИнгредиентов.Количество()) Тогда

		Ответ = Вопрос("Очистить все цены ингредиентов? Данные можно будет восстановить автозаполнением.",
			РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Нет);

		Если Ответ = КодВозвратаДиалога.Да Тогда

			Для Каждого СтрокаИнгредиент Из Объект.СоставИнгредиентов Цикл
				СтрокаИнгредиент.ЦенаИнгредиента = ПредопределенноеЗначение("Справочник.ЦеныНаИнгредиенты.ПустаяСсылка");
				СтрокаИнгредиент.СтоимостьЕдиницы = 0;
				СтрокаИнгредиент.СуммаСтоимости = 0;
			КонецЦикла;

			ОбновитьСебестоимостьПорцииНаСервере();
			Сообщить("Все цены очищены");

		КонецЕсли;

	Иначе
		Сообщить("Нет ингредиентов для очистки");
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура КопироватьЦеныИзДругойТехкарточки(Команда)

	// Копирование цен из другой техкарточки
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимВыбора", Истина);

	ОписаниеОповещения = Новый ОписаниеОповещения("КопироватьЦеныИзДругойТехкарточкиЗавершение", ЭтотОбъект);

	ОткрытьФорму("Справочник.Техкарточки.ФормаВыбора", ПараметрыФормы, ЭтотОбъект, , , , ОписаниеОповещения);

КонецПроцедуры

&НаКлиенте
Процедура ПоказатьИсториюЦенИнгредиента(Команда)

	// Показать историю изменения цен выбранного ингредиента
	ТекущаяСтрока = Элементы.СоставИнгредиентов.ТекущиеДанные;
	Если ТекущаяСтрока = Неопределено ИЛИ НЕ ЗначениеЗаполнено(ТекущаяСтрока.ЦенаИнгредиента) Тогда
		Сообщить("Выберите строку с заполненной ценой ингредиента");
		Возврат;
	КонецЕсли;

	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Ключ", ТекущаяСтрока.ЦенаИнгредиента);

	ОткрытьФорму("Справочник.ЦеныНаИнгредиенты.ФормаОбъекта", ПараметрыФормы);

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииСервера

&НаСервере
Функция ПолучитьЦенуИнгредиентаНаСервере(Ингредиент, ЦенаИнгредиента)

	// Серверный вызов для получения цены ингредиента
	Возврат РасчетСебестоимостиМодуль.ПолучитьЦенуИнгредиентаДляФормы(Ингредиент, ЦенаИнгредиента);

КонецФункции

&НаСервере
Процедура ОбновитьСебестоимостьПорцииНаСервере()

	// Полный пересчет себестоимости порции
	РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);

КонецПроцедуры

&НаСервере
Функция АвтозаполнениеЦенИнгредиентовНаСервере()

	КоличествоОбновленных = 0;

	// Проходим по всем ингредиентам и ищем активные цены
	Для Каждого СтрокаИнгредиент Из Объект.СоставИнгредиентов Цикл

		Если ЗначениеЗаполнено(СтрокаИнгредиент.Ингредиент) И НЕ ЗначениеЗаполнено(СтрокаИнгредиент.ЦенаИнгредиента) Тогда

			// Ищем активную цену для ингредиента
			АктивнаяЦена = НайтиАктивнуюЦенуДляИнгредиента(СтрокаИнгредиент.Ингредиент);

			Если ЗначениеЗаполнено(АктивнаяЦена) Тогда
				СтрокаИнгредиент.ЦенаИнгредиента = АктивнаяЦена;
				КоличествоОбновленных = КоличествоОбновленных + 1;
			КонецЕсли;

		КонецЕсли;

	КонецЦикла;

	// Если что-то заполнили - пересчитываем себестоимость
	Если КоличествоОбновленных > 0 Тогда
		РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);
	КонецЕсли;

	Возврат КоличествоОбновленных;

КонецФункции

&НаСервере
Функция НайтиАктивнуюЦенуДляИнгредиента(Ингредиент)

	// Поиск самой актуальной активной цены для ингредиента
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЦеныНаИнгредиенты.Ссылка КАК ЦенаСсылка
	|ИЗ
	|	Справочник.ЦеныНаИнгредиенты КАК ЦеныНаИнгредиенты
	|ГДЕ
	|	ЦеныНаИнгредиенты.Ингредиент = &Ингредиент
	|	И ЦеныНаИнгредиенты.Активность = ИСТИНА
	|	И НЕ ЦеныНаИнгредиенты.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЦеныНаИнгредиенты.ДатаУстановкиЦены УБЫВ";

	Запрос.УстановитьПараметр("Ингредиент", Ингредиент);

	РезультатЗапроса = Запрос.Выполнить();

	Если РезультатЗапроса.Пустой() Тогда
		Возврат Справочники.ЦеныНаИнгредиенты.ПустаяСсылка();
	КонецЕсли;

	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();

	Возврат Выборка.ЦенаСсылка;

КонецФункции

&НаСервере
Функция КопироватьЦеныИзТехкарточкиНаСервере(ТехкарточкаИсточник)

	КоличествоСкопированных = 0;

	Если НЕ ЗначениеЗаполнено(ТехкарточкаИсточник) Тогда
		Возврат КоличествоСкопированных;
	КонецЕсли;

	// Получаем состав ингредиентов источника
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТехкарточкиСоставИнгредиентов.Ингредиент КАК Ингредиент,
	|	ТехкарточкиСоставИнгредиентов.ЦенаИнгредиента КАК ЦенаИнгредиента
	|ИЗ
	|	Справочник.Техкарточки.СоставИнгредиентов КАК ТехкарточкиСоставИнгредиентов
	|ГДЕ
	|	ТехкарточкиСоставИнгредиентов.Ссылка = &ТехкарточкаИсточник
	|	И ЗначениеЗаполнено(ТехкарточкиСоставИнгредиентов.ЦенаИнгредиента)";

	Запрос.УстановитьПараметр("ТехкарточкаИсточник", ТехкарточкаИсточник);

	Выборка = Запрос.Выполнить().Выбрать();

	// Копируем цены для соответствующих ингредиентов
	Пока Выборка.Следующий() Цикл

		Для Каждого СтрокаИнгредиент Из Объект.СоставИнгредиентов Цикл

			Если СтрокаИнгредиент.Ингредиент = Выборка.Ингредиент И НЕ ЗначениеЗаполнено(СтрокаИнгредиент.ЦенаИнгредиента) Тогда
				СтрокаИнгредиент.ЦенаИнгредиента = Выборка.ЦенаИнгредиента;
				КоличествоСкопированных = КоличествоСкопированных + 1;
			КонецЕсли;

		КонецЦикла;

	КонецЦикла;

	// Пересчитываем себестоимость
	Если КоличествоСкопированных > 0 Тогда
		РасчетСебестоимостиМодуль.ОбновитьЦеныВТехКарточке(Объект);
	КонецЕсли;

	Возврат КоличествоСкопированных;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииКлиента

&НаКлиенте
Процедура РассчитатьСтоимостьИнгредиентаВСтроке(СтрокаИнгредиент)

	// Рассчитываем стоимость ингредиента в строке рецепта
	Если СтрокаИнгредиент.НормаБрутто > 0 И СтрокаИнгредиент.СтоимостьЕдиницы > 0 Тогда
		// НормаБрутто в граммах, СтоимостьЕдиницы за килограмм
		СтрокаИнгредиент.СуммаСтоимости = (СтрокаИнгредиент.НормаБрутто / 1000) * СтрокаИнгредиент.СтоимостьЕдиницы;
	Иначе
		СтрокаИнгредиент.СуммаСтоимости = 0;
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура АвтоматическиЗаполнитьЦенуСтроки(СтрокаИнгредиент)

	// Попытка автоматически найти цену для ингредиента
	Если ЗначениеЗаполнено(СтрокаИнгредиент.Ингредиент) И НЕ ЗначениеЗаполнено(СтрокаИнгредиент.ЦенаИнгредиента) Тогда

		АктивнаяЦена = НайтиАктивнуюЦенуДляИнгредиентаНаСервере(СтрокаИнгредиент.Ингредиент);

		Если ЗначениеЗаполнено(АктивнаяЦена) Тогда
			СтрокаИнгредиент.ЦенаИнгредиента = АктивнаяЦена;

			// Получаем цену и пересчитываем
			ЦенаЗаКг = ПолучитьЦенуИнгредиентаНаСервере(СтрокаИнгредиент.Ингредиент, АктивнаяЦена);
			СтрокаИнгредиент.СтоимостьЕдиницы = ЦенаЗаКг;
			РассчитатьСтоимостьИнгредиентаВСтроке(СтрокаИнгредиент);
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеЭлементовФормы()

	// Настройка видимости и доступности элементов формы
	Элементы.СоставИнгредиентовСтоимостьЕдиницы.ТолькоПросмотр = Истина;
	Элементы.СоставИнгредиентовСуммаСтоимости.ТолькоПросмотр = Истина;

КонецПроцедуры

&НаСервере
Функция НайтиАктивнуюЦенуДляИнгредиентаНаСервере(Ингредиент)

	// Серверный вызов для поиска активной цены
	Возврат НайтиАктивнуюЦенуДляИнгредиента(Ингредиент);

КонецФункции

&НаКлиенте
Процедура КопироватьЦеныИзДругойТехкарточкиЗавершение(ВыбранноеЗначение, ДополнительныеПараметры) Экспорт

	Если ЗначениеЗаполнено(ВыбранноеЗначение) И ВыбранноеЗначение <> Объект.Ссылка Тогда

		КоличествоСкопированных = КопироватьЦеныИзТехкарточкиНаСервере(ВыбранноеЗначение);

		Если КоличествоСкопированных > 0 Тогда
			Сообщить(СтрШаблон("Скопировано цен: %1", КоличествоСкопированных));
		Иначе
			Сообщить("Подходящих цен для копирования не найдено");
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры

#КонецОбласти